# 🎯 Phase 3 特徴量差異の最終調査 - 実行指示書

## ✅ 調査完了事項

### 原因の確定

**Phase 3学習時、Borutaによる特徴量選択が競馬場ごとに独立して実行された**

#### 証拠

1. **train_development.py (行105-142)**
```python
# Borutaによる特徴量選択
boruta_selector = BorutaPy(
    rf,
    n_estimators='auto',
    max_iter=100,
    random_state=42,
    verbose=0
)

boruta_selector.fit(X.values, y.values)  # ← 競馬場ごとに独立実行

# 選択された特徴量のみを使用
selected_features = X.columns[boruta_selector.support_].tolist()
```

2. **特徴量処理フローの完全再現**
```
SQL出力 (39カラム)
  ↓
target除外 (38カラム)
  ↓
ID列除外 (32カラム)
  ↓
Boruta選択 ← 🔴 ここで競馬場ごとに異なる結果
  ↓
大井: 32特徴量 (全選択 100%)
船橋: 34特徴量 (追加特徴量あり？)
```

---

## 🚨 新たな疑問点

### なぜ船橋は34特徴量？

**大井**: 32特徴量 (ID列除外後の全特徴量)
**船橋**: 34特徴量 (32より2つ多い)

**可能性**:
1. 船橋のCSVファイルに追加カラムが含まれていた
2. extract_training_data_v2.py のSQL定義が競馬場によって異なっていた
3. データ型の違いにより、船橋では別のカラムが数値として扱われた

---

## 🛠️ 今すぐ実行：確実な調査

### Windows環境での実行手順

```bash
cd E:\anonymous-keiba-ai
git pull origin phase4_specialized_models
```

### 実行1: 詳細分析

```bash
python analyze_venue_features_detailed.py
```

**目的**: 各競馬場のモデルから**実際の特徴量リスト**を抽出

**期待される情報**:
- 各競馬場の正確な特徴量数
- 各競馬場の正確な特徴量リスト
- 競馬場間の差異（追加/欠落特徴量）

### 実行2: 基本分析

```bash
python check_model_features.py
```

**目的**: シンプルな特徴量数の確認

---

## 📊 出力例（期待される結果）

### analyze_venue_features_detailed.py の出力

```
====================================================================================================
Phase 3モデルの特徴量完全分析
====================================================================================================

✅ 大井 (44): 32特徴量
✅ 船橋 (43): 34特徴量
✅ 川崎 (45): 33特徴量
...

====================================================================================================
特徴量数サマリー
====================================================================================================

32特徴量: 大井(44), 浦和(42), 笠松(47)
33特徴量: 川崎(45), 高知(54)
34特徴量: 船橋(43), 名古屋(48), 園田(50)

====================================================================================================
特徴量の詳細比較
====================================================================================================

基準モデル: 大井 (32特徴量)

🔵 大井 (44): 32特徴量 [基準モデル]
   特徴量リスト: barei, blinker_shiyo_kubun, ..., wakuban

🔴 船橋 (43): 34特徴量 [差異あり]
   追加の特徴量 (+2): prev1_last4f, prev5_time
   ← これらが追加されている！

...
```

---

## ✅ 調査完了後の対応

### 出力結果を共有してください

調査スクリプトを実行したら、**完全な出力内容**をコピーして共有してください。

特に重要な情報：
1. 各競馬場の特徴量数
2. **追加の特徴量**（基準モデルにない特徴量）
3. **欠落の特徴量**（基準モデルにあるが他の競馬場にない特徴量）

### 次のステップ

調査結果に基づいて、以下を実装します：

#### Option 1: 各競馬場の特徴量に完全対応（推奨⭐）

```python
def extract_2026_data_for_venue(venue_code):
    """競馬場ごとに異なる特徴量セットで抽出"""
    
    # 競馬場ごとのモデルから実際の特徴量リストを取得
    model = lgb.Booster(model_file=get_model_path(venue_code))
    required_features = model.feature_name()
    
    # SQLクエリを動的に生成
    feature_sql = generate_feature_sql(required_features)
    
    # データ抽出
    query = f"SELECT {feature_sql} FROM ..."
    df = pd.read_sql_query(query, conn)
    
    return df
```

**メリット**:
- Phase 3学習時と完全に一致
- 予測精度が保証される
- 既存モデルをそのまま使用

**実装時間**: 約1-2時間

---

## 🎯 最終目標

### 完全な整合性

```
Phase 3学習時のデータ構造 == 予測時のデータ構造
  ↓
エラーなし & 高精度な予測
```

### 妥協なし

- すべての競馬場で正確な特徴量を使用
- Phase 3との完全な互換性
- ハルシネーションなしの確実な実装

---

## 📝 実行チェックリスト

- [ ] `cd E:\anonymous-keiba-ai`
- [ ] `git pull origin phase4_specialized_models`
- [ ] `python analyze_venue_features_detailed.py` を実行
- [ ] 完全な出力結果をコピー
- [ ] 出力結果を共有
- [ ] 各競馬場の特徴量リストを確認
- [ ] Option 1の実装を開始

---

## 🔗 リソース

- **リポジトリ**: https://github.com/aka209859-max/anonymous-keiba-ai
- **PR #3**: https://github.com/aka209859-max/anonymous-keiba-ai/pull/3
- **最新コミット**: d3ae34d (2026-02-04)
- **ブランチ**: phase4_specialized_models

---

**🚀 今すぐ実行してください！**

調査結果が出たら、すぐに対応します。
