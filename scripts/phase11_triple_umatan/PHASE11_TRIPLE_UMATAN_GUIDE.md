# Phase 11: トリプル馬単システム完全ガイド

## 📖 目次

1. [概要](#概要)
2. [システム構成](#システム構成)
3. [インストール](#インストール)
4. [使用方法](#使用方法)
5. [戦略タイプ](#戦略タイプ)
6. [Kelly基準について](#kelly基準について)
7. [実行例](#実行例)
8. [注意事項](#注意事項)

---

## 概要

**Phase 11: トリプル馬単システム**は、地方競馬のSPAT4 LOTOトリプル馬単に特化した独立システムです。

### 🎯 主な機能

- ✅ キャリーオーバー情報の自動取得（南関東4場、門別、園田、姫路）
- ✅ 3レース連続的中確率の計算
- ✅ Kelly基準による最適投資額算出
- ✅ AI予想データを活用した買い目自動生成
- ✅ 複数の投資戦略シナリオ分析

### 🏇 対象競馬場

| 競馬場 | コード | フルゲート | 地域 |
|--------|--------|------------|------|
| 浦和 | 42 | 14頭 | 南関東 |
| 船橋 | 43 | 14頭 | 南関東 |
| 大井 | 44 | 16頭 | 南関東 |
| 川崎 | 45 | 14頭 | 南関東 |
| 門別 | 30 | 16頭 | ホッカイドウ |
| 園田 | 50 | 14頭 | 兵庫県 |
| 姫路 | 51 | 14頭 | 兵庫県 |

---

## システム構成

```
scripts/phase11_triple_umatan/
├── scrape_carryover.py              # キャリーオーバー取得
├── triple_probability_calculator.py  # 確率計算
├── triple_betting_strategy.py        # Kelly基準投資戦略
├── generate_triple_tickets.py        # 買い目生成
├── run_triple_umatan.py              # 統合実行
└── PHASE11_TRIPLE_UMATAN_GUIDE.md    # このドキュメント

data/triple_umatan/
├── carryover/          # キャリーオーバー情報
├── predictions/        # 買い目データ
└── results/            # 結果記録
```

---

## インストール

### 必要なライブラリ

```bash
pip install requests beautifulsoup4 lxml pandas numpy
```

### ディレクトリ作成

```bash
mkdir -p data/triple_umatan/{carryover,predictions,results}
```

---

## 使用方法

### 🔧 基本的な使い方

```bash
python scripts/phase11_triple_umatan/run_triple_umatan.py [競馬場コード] [ensemble CSV パス]
```

### 📝 実行例

#### 例1: 船橋競馬のトリプル馬単分析（デフォルト設定）

```bash
python scripts/phase11_triple_umatan/run_triple_umatan.py 43 data/predictions/phase5/船橋_20260214_ensemble.csv
```

#### 例2: 大井競馬、広範囲型戦略で分析

```bash
python scripts/phase11_triple_umatan/run_triple_umatan.py 44 data/predictions/phase5/大井_20260214_ensemble.csv --strategy aggressive
```

#### 例3: 総資金50万円、Full Kelly で分析

```bash
python scripts/phase11_triple_umatan/run_triple_umatan.py 43 data/predictions/phase5/船橋_20260214_ensemble.csv --bankroll 500000 --risk 1.0
```

### ⚙️ オプション

| オプション | 説明 | デフォルト |
|------------|------|------------|
| `--strategy` | 投資戦略タイプ | `balanced` |
| `--bankroll` | 総資金（円） | `100000` |
| `--risk` | リスク係数（0〜1） | `0.5` |

---

## 戦略タイプ

### 1. 超堅実型（conservative）

- **構成**: 各レースTOP2の馬単2点買い（2-2-2）
- **購入点数**: 8点
- **投資額**: 400円
- **推奨ケース**: キャリーオーバー1億円未満、または初心者

### 2. バランス型（balanced）⭐ 推奨

- **構成**: 1着本命1頭、2着候補3頭（3-3-3）
- **購入点数**: 27点
- **投資額**: 1,350円
- **推奨ケース**: キャリーオーバー1〜5億円

### 3. 広範囲型（aggressive）

- **構成**: 1着候補2頭、2着候補4頭（4-4-4）
- **購入点数**: 64点
- **投資額**: 3,200円
- **推奨ケース**: キャリーオーバー5億円以上

### 4. 超広範囲型（very_aggressive）

- **構成**: 1着候補3頭、2着候補6頭（6-6-6）
- **購入点数**: 216点
- **投資額**: 10,800円
- **推奨ケース**: キャリーオーバー10億円以上

---

## Kelly基準について

### 📊 Kelly公式

```
f* = (bp - q) / b

where:
  f* = 最適投資比率
  b  = オッズ - 1
  p  = 勝率
  q  = 1 - p
```

### 🎲 リスク係数

| リスク係数 | 説明 | 推奨度 |
|------------|------|--------|
| **1.0** (Full Kelly) | 最大成長率だが変動大 | ⚠️ 非推奨 |
| **0.5** (Half Kelly) | バランス型、推奨設定 | ✅ 推奨 |
| **0.25** (Quarter Kelly) | 保守的、低リスク | ✅ 安全 |

### ⚠️ 注意事項

- Kelly基準は**長期的な成長率最大化**を目指す手法
- **短期的な変動が大きい**ため、Half Kelly（0.5）以下を推奨
- 総資金の**25%を超える投資は避ける**べき

---

## 実行例

### 📈 実行フロー

```
[1/5] キャリーオーバー情報取得
  ↓ nankankeiba.com / spat4.jp からスクレイピング
  
[2/5] AI予想データ読み込み
  ↓ ensemble CSV を読み込み、最終3レースを抽出
  
[3/5] 確率・期待値計算
  ↓ フルゲート頭数から総組み合わせ数を算出
  
[4/5] 投資戦略分析
  ↓ Kelly基準で各シナリオの最適投資額を計算
  
[5/5] 買い目生成
  ↓ AI予想TOP馬から買い目を生成し、ファイル保存
```

### 📄 出力ファイル

#### 1. 買い目テキストファイル

```
data/triple_umatan/predictions/船橋_20260214_triple_balanced.txt
```

**内容例:**
```
================================================================================
トリプル馬単買い目
================================================================================
対象レース: 第10R - 第11R - 第12R
購入点数: 27点
投資額: 1,350円
================================================================================

第10R 馬単:
  1→2
  1→3
  1→4
  ...

第11R 馬単:
  5→6
  5→7
  5→8
  ...

第12R 馬単:
  9→10
  9→11
  9→12
  ...

--------------------------------------------------------------------------------
全27通りの組み合わせ
================================================================================
```

#### 2. 買い目JSONファイル

```
data/triple_umatan/predictions/船橋_20260214_triple_balanced.json
```

**内容例:**
```json
{
  "venue": "船橋",
  "date": "20260214",
  "strategy": "balanced",
  "race_numbers": [10, 11, 12],
  "num_tickets": 27,
  "total_cost": 1350,
  "tickets": [
    {
      "race1": {"1st": 1, "2nd": 2},
      "race2": {"1st": 5, "2nd": 6},
      "race3": {"1st": 9, "2nd": 10}
    },
    ...
  ]
}
```

#### 3. キャリーオーバー情報

```
data/triple_umatan/carryover/carryover_20260214.json
```

**内容例:**
```json
{
  "43": {
    "venue_name": "船橋",
    "venue_code": 43,
    "carryover": 270000000,
    "fullgate": 14,
    "timestamp": "2026-02-14T10:00:00"
  }
}
```

---

## 注意事項

### ⚠️ 法的・倫理的留意点

1. **スクレイピングの利用規約遵守**
   - nankankeiba.com と spat4.jp の利用規約を確認してください
   - robots.txt を遵守し、過度なアクセスを避けてください
   - アクセス頻度は1日1回程度に制限することを推奨

2. **投資リスク**
   - **控除率30%**: トリプル馬単の控除率は非常に高い
   - **期待値マイナス**: 多くの場合、長期的には損失が発生
   - **ギャンブル依存症**: 自己管理を徹底してください

3. **税務**
   - 高額配当（50万円以上）は**一時所得**として課税対象
   - 的中馬券の購入費用のみが経費として認められる
   - 外れ馬券は原則として経費にできない

### 🛡️ リスク管理

1. **総資金の管理**
   - 生活費に影響しない余裕資金で行うこと
   - 総資金の25%を超える投資は避ける

2. **損切りルール**
   - 連続して損失が出た場合は一時撤退を検討
   - 感情的な追加投資は避ける

3. **期待値の確認**
   - ROIがマイナスのシナリオは見送る
   - キャリーオーバーが少額の場合は参加しない

---

## トラブルシューティング

### Q1: キャリーオーバー情報が取得できない

**A1:** 以下を確認してください

```bash
# ネットワーク接続確認
ping www.nankankeiba.com

# Python ライブラリ確認
pip install --upgrade requests beautifulsoup4 lxml
```

### Q2: ensemble CSV が見つからない

**A2:** 既存の予想システム（Phase 0〜5）を先に実行してください

```bash
E:
cd E:\anonymous-keiba-ai
run_all_FINAL.bat 43 2026-02-14
```

### Q3: 買い目が0点になる

**A3:** 最終3レースのデータが不足している可能性があります

- ensemble CSV に最終3レースのデータが含まれているか確認
- `race_bango` カラムが正しいか確認

---

## まとめ

Phase 11 トリプル馬単システムは、**完全に独立した**投資分析ツールです。

### ✅ 主な特徴

- **既存システムと完全分離**: Phase 0〜10 とは独立して動作
- **Kelly基準による科学的アプローチ**: 長期的な最適投資戦略
- **柔軟な戦略選択**: 4つの投資戦略から選択可能
- **自動化**: キャリーオーバー取得から買い目生成まで一貫処理

### ⚠️ 重要な注意

- トリプル馬単は**超高難度**（的中確率: 約1/600万〜1,400万）
- 控除率30%により、**長期的には損失が発生する可能性が高い**
- **エンターテインメント**として楽しむことを推奨
- **ギャンブル依存症に注意**し、余裕資金で行うこと

---

## サポート

問題が発生した場合は、以下のログファイルを確認してください:

```bash
# 実行ログの確認
cat data/triple_umatan/predictions/船橋_20260214_triple_balanced.txt

# キャリーオーバー情報の確認
cat data/triple_umatan/carryover/carryover_20260214.json
```

---

**Enjoy Responsible Betting! 🏇💰**
