#!/bin/bash
# ==================================================
# 地方競馬AI予想システム - 毎日運用スクリプト
# Note & ブッカーズ用テキスト自動生成
# ==================================================

# 基本設定
cd "$(dirname "$0")/../.." || exit 1
BASE_DIR=$(pwd)

# ============================================
# 競馬場名マッピング関数
# ============================================
get_keiba_name() {
    case "$1" in
        30) echo "門別" ;;
        35) echo "盛岡" ;;
        36) echo "水沢" ;;
        42) echo "浦和" ;;
        43) echo "船橋" ;;
        44) echo "大井" ;;
        45) echo "川崎" ;;
        46) echo "金沢" ;;
        47) echo "笠松" ;;
        48) echo "名古屋" ;;
        50) echo "園田" ;;
        51) echo "姫路" ;;
        54) echo "高知" ;;
        55) echo "佐賀" ;;
        *) echo "" ;;
    esac
}

# ============================================
# 使用方法表示
# ============================================
show_usage() {
    cat << EOF
==================================================
🏇 地方競馬AI予想 - 配信用テキスト生成
==================================================

使用方法:
  ./daily_operation.sh [競馬場コード] [対象日付]

競馬場コード一覧:
  30: 門別    35: 盛岡    36: 水沢    42: 浦和
  43: 船橋    44: 大井    45: 川崎    46: 金沢
  47: 笠松    48: 名古屋  50: 園田    51: 姫路
  54: 高知    55: 佐賀

日付フォーマット: YYYY-MM-DD

使用例:
  # 佐賀競馬 2026年2月8日
  ./daily_operation.sh 55 2026-02-08

  # 大井競馬 2026年2月10日
  ./daily_operation.sh 44 2026-02-10

  # 川崎競馬 2026年2月10日
  ./daily_operation.sh 45 2026-02-10

==================================================
EOF
    exit 1
}

# ============================================
# 引数チェック
# ============================================
if [ $# -ne 2 ]; then
    show_usage
fi

KEIBA_CODE="$1"
TARGET_DATE="$2"

# 競馬場名取得
KEIBA_NAME=$(get_keiba_name "$KEIBA_CODE")

if [ -z "$KEIBA_NAME" ]; then
    echo "[エラー] 無効な競馬場コード: $KEIBA_CODE"
    show_usage
fi

# ============================================
# 日付フォーマット変換
# ============================================
# YYYY-MM-DD → YYYYMMDD
DATE_SHORT=$(echo "$TARGET_DATE" | tr -d '-')

# ============================================
# ファイルパス設定
# ============================================
ENSEMBLE_CSV="data/predictions/phase5/${KEIBA_NAME}_${DATE_SHORT}_ensemble.csv"
NOTE_TXT="predictions/${KEIBA_NAME}_${DATE_SHORT}_note.txt"
BOOKERS_TXT="predictions/${KEIBA_NAME}_${DATE_SHORT}_bookers.txt"

echo "=================================================="
echo "🏇 地方競馬AI予想 - 配信用テキスト生成"
echo "=================================================="
echo ""
echo "競馬場: $KEIBA_NAME (コード: $KEIBA_CODE)"
echo "対象日: $TARGET_DATE"
echo ""
echo "入力CSV: $ENSEMBLE_CSV"
echo "出力1  : $NOTE_TXT"
echo "出力2  : $BOOKERS_TXT"
echo ""
echo "=================================================="

# ============================================
# 入力ファイル存在確認
# ============================================
if [ ! -f "$ENSEMBLE_CSV" ]; then
    echo "[エラー] 入力ファイルが見つかりません"
    echo "ファイル: $ENSEMBLE_CSV"
    echo ""
    echo "Phase 5 までの処理が完了しているか確認してください。"
    exit 1
fi

# ============================================
# Phase 6-1: Note用テキスト生成
# ============================================
echo ""
echo "[Phase 6-1] Note用テキスト生成中..."
python3 scripts/phase6_betting/generate_distribution_note.py "$ENSEMBLE_CSV" "$NOTE_TXT"

if [ $? -ne 0 ]; then
    echo "[エラー] Note用テキスト生成に失敗しました"
    exit 1
fi

echo "[完了] Note用テキスト生成完了: $NOTE_TXT"
echo ""

# ============================================
# Phase 6-2: ブッカーズ用テキスト生成
# ============================================
echo "[Phase 6-2] ブッカーズ用テキスト生成中..."
python3 scripts/phase6_betting/generate_distribution_bookers.py "$ENSEMBLE_CSV" "$BOOKERS_TXT"

if [ $? -ne 0 ]; then
    echo "[エラー] ブッカーズ用テキスト生成に失敗しました"
    exit 1
fi

echo "[完了] ブッカーズ用テキスト生成完了: $BOOKERS_TXT"
echo ""

# ============================================
# 完了メッセージと次のステップ
# ============================================
echo "=================================================="
echo "✅ すべての処理が完了しました！"
echo "=================================================="
echo ""
echo "📝 生成されたファイル:"
echo "  1. Note用    : $NOTE_TXT"
echo "  2. ブッカーズ用: $BOOKERS_TXT"
echo ""
echo "📋 次のステップ:"
echo "  1. 各ファイルを開いて内容を確認"
echo "  2. Note に投稿（コピー＆ペースト）"
echo "  3. ブッカーズに投稿（コピー＆ペースト）"
echo ""
echo "🚀 確認用コマンド:"
echo "  cat \"$NOTE_TXT\""
echo "  cat \"$BOOKERS_TXT\""
echo ""
echo "=================================================="
