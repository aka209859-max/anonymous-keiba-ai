# 🔍 旧モデルと新モデルの比較レポート

**作成日**: 2026-02-11  
**目的**: 旧モデル（Phase 3-4）と新モデル（Phase 7-8）のスコアの意味を比較

---

## 📊 **旧モデル（Phase 3-4-5）のスコア**

### **スコアの計算方法**

```python
# 旧モデルのアンサンブルスコア計算
ensemble_score = (
    binary_normalized × 0.3 +      # Binary分類（複勝圏内確率）
    ranking_normalized × 0.5 +     # Ranking予測（相対的強さ）
    regression_normalized × 0.2    # Regression予測（走破タイム）
)
```

### **正規化プロセス**

#### **1. レースごとに各モデルのスコアを0〜1に正規化**
```python
# Binary: 高いほど良い（複勝確率）
binary_normalized = (binary - min) / (max - min)

# Ranking: 高いほど良い（相対的強さ）
ranking_normalized = (ranking - min) / (max - min)

# Regression: 小さいほど良い（タイム）
regression_normalized = 1.0 - (time - min) / (max - min)
```

#### **2. 重み付け統合**
- Binary: 30%
- Ranking: 50%（最重要）
- Regression: 20%

#### **3. レース内で再度0〜1に正規化**
```python
final_score = (ensemble_score - min) / (max - min)
```

---

## 📋 **旧モデルのスコア例（2026年02月12日 船橋）**

### **第1R: タイセイリノ（7番）**
- **スコア: 0.98** （ランクS）
- **意味**: レース内で最も高い評価（1位予測）
- ❌ **複勝率98%ではない**
- ✅ **レース内での相対的な強さ = 0.98（最高値）**

### **第10R: マイベネラブル（7番）**
- **スコア: 0.99** （ランクS）
- **意味**: レース内で圧倒的な評価（1位予測）
- **解釈**: Binary, Ranking, Regression全てで高評価

---

## 🆚 **旧モデル vs 新モデル（Phase 7-8）**

| 項目 | 旧モデル（Phase 3-4-5） | 新モデル（Phase 7-8-5） |
|------|------------------------|------------------------|
| **Phase 3** | Binary分類（全特徴量） | Phase 7 Binary（31特徴量選択） |
| **Phase 4** | Ranking/Regression（全特徴量） | Phase 7 Ranking（25特徴量） + Regression（24特徴量） |
| **Phase 8** | ❌ なし | ✅ Optuna最適化（100 trials） |
| **特徴量選択** | ❌ なし（全特徴量使用） | ✅ Boruta特徴量選択 |
| **ハイパーパラメータ** | デフォルト値 | Optuna最適化済み |
| **モデル品質** | 標準 | **最適化済み（高品質）** |

---

## 📊 **スコアの意味（共通）**

### **旧モデルも新モデルも同じ意味**

| スコア範囲 | ランク | 意味 |
|-----------|--------|------|
| **0.80〜1.00** | **S** | **最有力候補（レース内で圧倒的評価）** |
| 0.70〜0.79 | A | 有力候補（上位評価） |
| 0.60〜0.69 | B | 注目候補（中位評価） |
| 0.50〜0.59 | C | 穴候補（やや低評価） |
| 0.00〜0.49 | D | 警戒候補（低評価） |

### **❌ スコアは複勝率ではない**

- スコア 0.98 ≠ 複勝率98%
- スコア 0.98 = **レース内で最も高い評価**

### **✅ 実際の複勝率を見るには**

**新モデル（Phase 7-8）の場合:**
```csv
race_id,umaban,binary_probability,ensemble_score,final_rank
2020_0107_43_03,12,0.798,0.500,2

↑
これが複勝率79.8%
```

**旧モデルの場合:**
- Binary分類の生スコアを確認する必要あり
- 通常は別ファイルに格納されている

---

## 🎯 **新モデル（Phase 7-8）の優位性**

### **1. Phase 7: Boruta特徴量選択**
- **旧**: 全特徴量（約50個）を使用 → ノイズが多い
- **新**: 重要特徴量のみ選択（Binary: 31個、Ranking: 25個、Regression: 24個） → ノイズ削減

### **2. Phase 8: Optuna最適化**
- **旧**: デフォルトのハイパーパラメータ
- **新**: 100回の試行で最適化 → 精度向上

### **3. 予測精度の向上**
- **旧**: 標準的な精度
- **新**: Phase 7/8 で最適化済み → **精度向上が期待される**

---

## 📋 **船橋での比較（2026-02-12）**

### **旧モデルの第1R予測**
```
1位: 7番 タイセイリノ（スコア: 0.98）
2位: 3番 アレナメヒコ（スコア: 0.85）
3位: 1番 ハイパーファイン（スコア: 0.74）
```

### **新モデルの予測（Phase 7-8）**
- まだ実行していない（テストデータ未作成）
- **実行すれば同じフォーマットで出力される**

**出力例:**
```csv
race_id,umaban,ensemble_score,final_rank,binary_probability
2026_0212_43_01,7,0.98,1,0.75
2026_0212_43_01,3,0.85,2,0.68
2026_0212_43_01,1,0.74,3,0.62
```

---

## 🚀 **残り13会場への取り組み方針**

### **対象期間**
- **2025/01/01 〜 2025/12/31**（1年間）

### **実行計画**

#### **Phase 1: 学習データ生成（2025年データ）**
```bash
# 既存データは 2020-2026 → 2025年のみに絞る必要なし
# 既存の学習データをそのまま使用
```

#### **Phase 2: Phase 7 Ranking（13会場）**
```bash
cd E:\anonymous-keiba-ai
.\run_phase7_ranking_all.ps1
```
→ 推定時間: 2〜4時間

#### **Phase 3: Phase 7 Regression（13会場）**
```bash
.\run_phase7_regression_all.ps1
```
→ 推定時間: 2〜4時間

#### **Phase 4: Phase 8 Ranking（13会場）**
```bash
.\run_phase8_ranking_all.ps1
```
→ 推定時間: 6〜13時間

#### **Phase 5: Phase 8 Regression（13会場）**
```bash
.\run_phase8_regression_all.ps1
```
→ 推定時間: 6〜13時間

---

## 📊 **予測精度の評価方法（2025年データで検証）**

### **Step 1: 2025年データを学習/テストに分割**
```python
# 2025年1月〜9月: 学習用
# 2025年10月〜12月: テスト用
```

### **Step 2: 旧モデルと新モデルで予測**
```bash
# 旧モデル（Phase 3-4-5）
python scripts/phase5_ensemble/ensemble_predictions.py

# 新モデル（Phase 7-8-5）
python scripts/phase5_ensemble/ensemble_optimized.py
```

### **Step 3: 精度比較**
```python
# 的中率比較
- 単勝的中率
- 複勝的中率
- 馬連的中率
- 3連複的中率

# スコア比較
- NDCG@3（上位3頭の予測精度）
- 平均着順誤差
```

---

## 🎯 **まとめ**

### **旧モデルのスコア**
- ✅ レース内での相対的な評価（0〜1）
- ❌ 複勝率ではない
- ✅ スコアが高い = 予測着順が上位

### **新モデルの優位性**
1. ✅ Phase 7: 重要特徴量のみ使用（ノイズ削減）
2. ✅ Phase 8: ハイパーパラメータ最適化（精度向上）
3. ✅ Binary Probability が明確（複勝率が直接わかる）

### **次のアクション**
1. **Phase 7 Ranking 実行**（13会場）
2. **Phase 7 Regression 実行**（13会場）
3. **Phase 8 Ranking/Regression 実行**（13会場）
4. **2025年データで精度検証**

---

**旧モデルのスコア0.98も新モデルのensemble_score 0.55も、どちらも「レース内での相対的な強さ」を表しており、複勝率ではありません。**

**複勝率を知りたい場合は、新モデルの `binary_probability` カラムを確認してください！**
