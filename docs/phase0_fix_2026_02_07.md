# Phase 0 修正レポート（2026-02-07）

## 📋 修正概要

**日付**: 2026年2月7日  
**修正対象**: `scripts/phase0_data_acquisition/extract_race_data.py`  
**修正理由**: PC-KEIBAデータベースの実際のカラム名との不一致によるSQLエラー

---

## 🚨 発見された問題

### **問題1: 存在しないカラムの参照**

**エラー内容**:
```sql
SELECT race_me, course_kubun FROM nvd_ra ...
-- ❌ PostgreSQL Error: column "race_me" does not exist
-- ❌ PostgreSQL Error: column "course_kubun" does not exist
```

**原因**:
- `race_me` と `course_kubun` は **PC-KEIBAデータベースに存在しないカラム**
- 他社API（netkeiba等）やWeb scraping で使用される英語的な論理名を誤って使用
- PC-KEIBAは **日本語のローマ字表記** を物理カラム名として採用

### **問題2: データ取得の失敗**

- 空の DataFrame が返される
- Phase 1 以降が不完全なデータで動作
- 結果として **16カラムのみ** が出力され、49カラム中 **33カラムが欠損**

---

## ✅ 実施した修正

### **修正内容**

#### 1. **get_target_races() 関数の修正**

**修正前**:
```python
SELECT 
    race_me,        # ❌ 存在しない
    course_kubun,   # ❌ 存在しない
    ...
FROM nvd_ra
```

**修正後**:
```python
SELECT 
    hondai,              # ✅ レース名（本題）
    -- course_kubun は削除（存在しないため）
    track_code,          # ✅ ダート/芝/ばんえいの区別
    tenko_code,          # ✅ 天候コード
    grade_code,          # ✅ グレードコード
    ...
FROM nvd_ra
WHERE track_code != '00'  # ✅ ばんえい競馬を除外
```

#### 2. **get_horse_entries() 関数の修正**

**修正前**:
- 一部の重要なカラム（`tenko_code`, `shusso_tosu`, `grade_code` など）が欠落
- 過去走データのクエリが不完全

**修正後**:
```python
-- ✅ extract_training_data_v2.py と完全に同じクエリ構造を採用
WITH target_race AS (
    SELECT 
        se.chokyoshi_code,       -- ✅ 調教師コード
        se.blinker_shiyo_kubun,  -- ✅ ブリンカー
        se.tozai_shozoku_code,   -- ✅ 東西所属
        ra.tenko_code,           -- ✅ 天候
        ra.shusso_tosu,          -- ✅ 出走頭数
        ra.grade_code,           -- ✅ グレード
        um.moshoku_code,         -- ✅ 毛色
        ...
    FROM nvd_se se
    INNER JOIN nvd_ra ra ...
    LEFT JOIN nvd_um um ...
    WHERE ra.track_code != '00'  -- ✅ ばんえい競馬を除外
),
past_races AS (
    -- ✅ 過去5走分のデータを正しく取得
    SELECT ...
    FROM nvd_se se
    WHERE ra.track_code != '00'  -- ✅ ばんえい競馬を除外
)
```

#### 3. **ばんえい競馬の除外**

**重要**:
- 帯広競馬場（keibajo_code = '33'）の **ばんえい競馬**（`track_code = '00'`）を除外
- ばんえい競馬は体重1トン近い馬が鉄ソリを曳く競技で、通常の競馬とは異なる
- タイムの概念が全く異なるため、学習データに混入すると速度指数の正規化を破壊

**除外フィルタ**:
```sql
WHERE track_code != '00'  -- ばんえい競馬を除外
```

---

## 📊 修正後の期待される出力

### **Phase 0 出力**

**ファイル名**: `data/raw/YYYY/MM/{keibajo}_{YYYYMMDD}_raw.csv`

**期待されるカラム数**: **約60カラム**
- 基本情報: 6カラム
- レース情報: 10カラム（tenko_code, shusso_tosu, grade_code 含む）
- 出馬情報: 8カラム（chokyoshi_code, blinker_shiyo_kubun 含む）
- 馬情報: 2カラム（bamei, moshoku_code 含む）
- 過去走データ: 33カラム（prev1〜prev5 の全データ）

### **Phase 1 出力**

**ファイル名**: `data/features/YYYY/MM/{keibajo}_{YYYYMMDD}_features.csv`

**期待されるカラム数**: **50カラム**（race_id + 49特徴量）
- 識別情報: 6カラム
- レース情報: 7カラム
- 出馬情報: 8カラム
- 馬情報: 1カラム
- 過去走データ: 27カラム（prev1〜prev5）

---

## 🔍 PC-KEIBAデータベースの正しいカラム名

### **nvd_ra（レースマスタ）テーブル**

| 誤った名前 | 正しい名前 | 説明 |
|-----------|-----------|------|
| `race_me` | `hondai` | レース名（本題） |
| `race_name` | `hondai` | レース名 |
| `course_kubun` | 存在しない | トラック種別は `track_code` を使用 |
| `weather` | `tenko_code` | 天候コード |
| `distance` | `kyori` | 距離 |
| `grade` | `grade_code` | グレード（G1, G2, G3等） |

### **nvd_se（競走馬成績マスタ）テーブル**

| 誤った名前 | 正しい名前 | 説明 |
|-----------|-----------|------|
| `horse_name` | `bamei` | 馬名 |
| `jockey_id` | `kishu_code` | 騎手コード |
| `trainer_id` | `chokyoshi_code` | 調教師コード |
| `horse_weight` | `bataiju` | 馬体重 |
| `rank` | `kakutei_chakujun` | 確定着順 |
| `time` | `soha_time` | 走破タイム |

---

## 🎯 今後の推奨事項

### **1. データベーススキーマの参照**

- PC-KEIBAの公式ドキュメント「地方競馬AI予測システムにおけるPC-KEIBAデータベース構造の完全解析」を参照
- 新しいカラムを追加する前に、必ず実際のテーブル構造を確認

### **2. 学習用スクリプトとの整合性維持**

- `extract_training_data_v2.py` と `extract_race_data.py` のSQL構造を統一
- 今回の修正により、両者は **完全に同じ特徴量** を取得可能

### **3. テストデータでの検証**

```bash
# Phase 0 実行
python scripts/phase0_data_acquisition/extract_race_data.py --keibajo 55 --date 20260207

# 出力確認
python -c "import pandas as pd; df=pd.read_csv('data/raw/2026/02/saga_20260207_raw.csv'); print(f'カラム数: {len(df.columns)}'); print(df.columns.tolist())"

# Phase 1 実行
python prepare_features.py data/raw/2026/02/saga_20260207_raw.csv
```

### **4. エラーハンドリングの強化**

- SQL実行時のエラーメッセージを詳細に出力
- カラムの存在確認を事前に実施
- トレースバックを常に表示

---

## 📝 修正ファイル一覧

### **新規作成**
- `scripts/phase0_data_acquisition/extract_race_data.py` - 完全版（修正済み）
- `docs/phase0_fix_2026_02_07.md` - 本ドキュメント

### **参照資料**
- `地方競馬AI予測システムにおけるPC-KEIBAデータベース構造の完全解析.md`
- `extract_training_data_v2.py` - 学習用データ取得スクリプト（正しいカラム名使用）

---

## ✅ 修正の検証方法

### **Step 1: Phase 0 実行**
```bash
cd E:\anonymous-keiba-ai
python scripts\phase0_data_acquisition\extract_race_data.py --keibajo 55 --date 20260207
```

**期待される出力**:
```
[INFO] Phase 0: データ抽出開始
  競馬場: 佐賀 (55)
  開催日: 20260207
[INFO] 対象レース数: 12
[SUCCESS] データ保存完了
  出力ファイル: data/raw/2026/02/saga_20260207_raw.csv
  レコード数: 126件
  カラム数: 60個
✅ [SUCCESS] 必要な特徴量（過去走データ・馬名等）はすべて正常に含まれています
```

### **Step 2: カラム数の確認**
```bash
python -c "import pandas as pd; df=pd.read_csv('data/raw/2026/02/saga_20260207_raw.csv', encoding='utf-8'); print('カラム数:', len(df.columns)); print('prev1_rank' in df.columns, 'chokyoshi_code' in df.columns, 'bamei' in df.columns)"
```

**期待される出力**:
```
カラム数: 60
True True True
```

### **Step 3: Phase 1 実行**
```bash
python prepare_features.py data\raw\2026\02\saga_20260207_raw.csv
```

**期待される出力**:
```
[4/6] 特徴量フィルタリング中...
✅ 使用可能な特徴量: 50 / 50
✅ 特徴量フィルタリング完了
  - 最終特徴量数: 50個
```

---

## 🔗 参考資料

1. **PC-KEIBAデータベース構造の完全解析** - 2026-02-07アップロード
   - nvd_ra, nvd_se, nvd_um テーブルの完全なカラム定義
   - 正しいカラム名のマッピング
   - ばんえい競馬の扱いに関する注意事項

2. **extract_training_data_v2.py** - 学習用データ取得スクリプト
   - 正しいPC-KEIBAカラム名を使用
   - 過去走データを含む完全版

3. **roadmap.md** - プロジェクトロードマップ
   - Phase 0〜5 の全体像

---

**修正日**: 2026年2月7日  
**修正者**: Claude (AI Developer)  
**レビュー**: 未実施  
**次回レビュー予定**: Phase 0実行後
