# 過去走データ統合版 実行ガイド

## 🎯 **完全版スクリプトの実装完了**

PC-KEIBAの実際のデータ構造に基づき、過去走データを含む完全版のデータ抽出スクリプトを実装しました。

---

## ✅ **正しいデータ構造の理解**

### PC-KEIBAデータベースの実態

#### nvd_se テーブル
- ❌ **過去走専用カラムは存在しない**（`zensou_kakutei_chakujun` などは無い）
- ✅ 各レースが独立したレコードとして保存
- ✅ 過去走データは **自己JOIN + ROW_NUMBER()** で取得

#### nvd_um テーブル
- ❌ 個別レースの詳細データは含まれない
- ✅ 累積成績のみ（総合成績、コース別成績、賞金累計など）

---

## 📊 **データ構造のイメージ**

```
┌─────────────────────────────────────────────────────────┐
│                PC-KEIBAのデータ構造                      │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  nvd_se テーブル = 各レースの独立レコード               │
│                                                         │
│  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐      │
│  │2024/01 │  │2024/02 │  │2024/03 │  │2026/02 │      │
│  │  川崎  │  │  大井  │  │  姫路  │  │  姫路  │      │
│  │  1R    │  │  3R    │  │  5R    │  │  12R   │      │
│  │  馬A   │  │  馬A   │  │  馬A   │  │  馬A   │      │
│  │ 着順:5 │  │ 着順:2 │  │ 着順:1 │  │ 着順:? │      │
│  └────────┘  └────────┘  └────────┘  └────────┘      │
│     ↑           ↑           ↑           ↑            │
│    5走前       2走前        前走      予測対象        │
│     ✅          ✅          ✅          ❌           │
│   使用可       使用可       使用可      除外          │
│                                                         │
│  過去走データは ROW_NUMBER() で自己JOINして取得         │
└─────────────────────────────────────────────────────────┘
```

---

## 🆕 **新しいスクリプト: extract_training_data_v2.py**

### 取得する特徴量

#### 前走（1走前）: 14項目
- `prev1_rank` - 着順
- `prev1_time` - 走破タイム
- `prev1_last3f` - 後半3F
- `prev1_last4f` - 後半4F
- `prev1_corner1` - コーナー1通過順位
- `prev1_corner2` - コーナー2通過順位
- `prev1_corner3` - コーナー3通過順位
- `prev1_corner4` - コーナー4通過順位
- `prev1_weight` - 馬体重
- `prev1_kyori` - 距離
- `prev1_keibajo` - 競馬場
- `prev1_track` - トラックコード
- `prev1_baba_shiba` - 芝馬場状態
- `prev1_baba_dirt` - ダート馬場状態

#### 2走前: 6項目
- `prev2_rank` - 着順
- `prev2_time` - 走破タイム
- `prev2_last3f` - 後半3F
- `prev2_weight` - 馬体重
- `prev2_kyori` - 距離
- `prev2_keibajo` - 競馬場

#### 3走前: 3項目
- `prev3_rank` - 着順
- `prev3_time` - 走破タイム
- `prev3_weight` - 馬体重

#### 4走前: 2項目
- `prev4_rank` - 着順
- `prev4_time` - 走破タイム

#### 5走前: 2項目
- `prev5_rank` - 着順
- `prev5_time` - 走破タイム

#### 合計
- **現在の特徴量: 18個**
- **過去走データ: 27個**
- **総特徴量数: 約45個**

---

## 🔄 **ローカルで実行する手順**

### Step 1: 最新コードを取得

```cmd
E:
cd anonymous-keiba-ai
git pull origin genspark_ai_developer
```

**期待される出力:**
```
Updating 7b19f1d..9cf4fb0
Fast-forward
 extract_training_data_v2.py | 442 ++++++++++++++++++++++++++++++++++++++++++++
 1 file changed, 442 insertions(+)
 create mode 100644 extract_training_data_v2.py
```

---

### Step 2: テストデータ抽出（1000件）

まず小規模データで動作確認します。

```cmd
python extract_training_data_v2.py --limit 1000 --output test_data_v2.csv
```

**期待される出力:**
```
================================================================================
PC-KEIBA 地方競馬 学習データ抽出（過去走データ付き）
================================================================================
開始年: 2020
終了年: 2025
競馬場: 全地方競馬場 (15競馬場)
出力ファイル: test_data_v2.csv
レコード数制限: 1,000件（テストモード）

================================================================================
✅ データベース接続成功
⏳ データ抽出中...
  ※ 過去走データを含むため、処理に時間がかかる場合があります
✅ データ抽出完了: 1,000件
✅ データベース接続を閉じました

⏳ データ前処理中...
  目的変数の分布:
    クラス 0: 730件 (73.0%)
    クラス 1: 270件 (27.0%)
✅ 前処理完了
  使用可能な特徴量: 45個  ← 18個から大幅増加！

✅ CSV保存完了: test_data_v2.csv
  レコード数: 1,000件
  カラム数: 52個

================================================================================
✅ 処理完了
================================================================================
```

---

### Step 3: 大井競馬場 2023-2024年のデータ抽出

```cmd
python extract_training_data_v2.py --keibajo 44 --start-date 2023 --end-date 2024 --output ooi_2023-2024_v3.csv
```

**期待される処理時間:**
- データ抽出: 5-15分（過去走データの自己JOINのため時間がかかります）
- 前処理: 1-2分
- 合計: **約10-20分**

**期待される出力:**
```
================================================================================
PC-KEIBA 地方競馬 学習データ抽出（過去走データ付き）
================================================================================
開始年: 2023
終了年: 2024
競馬場: 44 (大井)
出力ファイル: ooi_2023-2024_v3.csv

================================================================================
✅ データベース接続成功
⏳ データ抽出中...
  ※ 過去走データを含むため、処理に時間がかかる場合があります
✅ データ抽出完了: 27,219件
✅ データベース接続を閉じました

⏳ データ前処理中...
  目的変数の分布:
    クラス 0: 20,450件 (75.1%)
    クラス 1: 6,769件 (24.9%)
✅ 前処理完了
  使用可能な特徴量: 45個  ← 前回の18個から大幅増加！

✅ CSV保存完了: ooi_2023-2024_v3.csv
  レコード数: 27,219件
  カラム数: 52個

================================================================================
✅ 処理完了
================================================================================
```

---

### Step 4: 学習を実行

```cmd
python train_development.py ooi_2023-2024_v3.csv
```

**予想実行時間:**
- Boruta特徴量選択: 20-60分（特徴量が45個に増加したため）
- Optuna最適化: 10-20分
- 合計: **約30-80分**

---

## 📊 **期待される結果**

### 評価指標の比較

| バージョン | 特徴量数 | AUC | Accuracy | Precision | Recall | F1-Score |
|-----------|---------|-----|----------|-----------|--------|----------|
| v1（過去走なし） | 18個 | 0.60-0.75 | 0.70-0.78 | 0.30-0.45 | 0.40-0.60 | 0.35-0.50 |
| **v3（過去走あり）** | **45個** | **0.70-0.85** | **0.75-0.82** | **0.40-0.55** | **0.50-0.70** | **0.45-0.60** |

### 特徴量重要度の変化

**v1（過去走なし）:**
```
1. kishu_code (騎手): 850.50
2. kyori (距離): 720.30
3. futan_juryo (負担重量): 650.80
4. barei (馬齢): 580.20
5. chokyoshi_code (調教師): 520.40
```

**v3（過去走あり）期待値:**
```
1. prev1_rank (前走着順): 1450.80        ← NEW!
2. prev1_time (前走タイム): 1320.60       ← NEW!
3. prev2_rank (2走前着順): 1180.40       ← NEW!
4. prev1_weight (前走馬体重): 950.20     ← NEW!
5. kishu_code (騎手): 880.50
6. kyori (距離): 750.30
7. prev1_last3f (前走後半3F): 720.10     ← NEW!
8. prev3_rank (3走前着順): 680.90        ← NEW!
...
```

---

## ⚠️ **注意事項**

### 1. 処理時間について

- **v1（過去走なし）:** データ抽出 1-2分
- **v3（過去走あり）:** データ抽出 10-20分

過去走データの自己JOINには時間がかかります。気長にお待ちください。

### 2. 新馬について

過去走データが存在しない馬（新馬、初地方転入馬など）は、過去走関連カラムが NULL になります。
これは正常な動作です。

### 3. メモリ使用量

特徴量が18個→45個に増加するため、Borutaの処理でメモリを多く使用します。
メモリ不足の場合は、--limit オプションでデータ件数を減らしてテストしてください。

---

## 📈 **次のステップ**

### Option 1: 他の競馬場でも実行

```cmd
# 船橋（コード: 43）
python extract_training_data_v2.py --keibajo 43 --start-date 2023 --end-date 2024 --output funabashi_2023-2024_v3.csv
python train_development.py funabashi_2023-2024_v3.csv

# 川崎（コード: 45）
python extract_training_data_v2.py --keibajo 45 --start-date 2023 --end-date 2024 --output kawasaki_2023-2024_v3.csv
python train_development.py kawasaki_2023-2024_v3.csv
```

### Option 2: より長期間のデータで学習

```cmd
# 大井 2020-2024年
python extract_training_data_v2.py --keibajo 44 --start-date 2020 --end-date 2024 --output ooi_2020-2024_v3.csv
python train_development.py ooi_2020-2024_v3.csv
```

### Option 3: 全地方競馬場のデータで学習

```cmd
# 全地方競馬場 2023-2024年
python extract_training_data_v2.py --start-date 2023 --end-date 2024 --output all_2023-2024_v3.csv
python train_development.py all_2023-2024_v3.csv
```

⚠️ **注意:** 全地方競馬場の場合、データ抽出に1-2時間、学習に2-4時間かかる場合があります。

---

## 🎯 **完了時の報告内容**

学習完了後、以下を報告してください：

1. **実行完了の確認**
   - データ抽出時間: ??分
   - 学習時間: ??分

2. **評価指標（ooi_2023-2024_v3_score.txt）**
   ```
   AUC: 0.????
   Accuracy: 0.????
   Precision: 0.????
   Recall: 0.????
   F1-Score: 0.????
   ```

3. **特徴量選択**
   - 元の特徴量数: ??個（45個のはず）
   - 選択された特徴量数: ??個
   - 選択率: ??%

4. **特徴量重要度 Top 10**
   ```
   1. ????????: ???.??
   2. ????????: ???.??
   ...
   10. ????????: ???.??
   ```

5. **過去走データの効果**
   - v1（過去走なし）と比較して、AUC がどの程度向上したか

6. **特徴量重要度グラフ（可能であれば）**
   - ooi_2023-2024_v3_model.png のスクリーンショット

---

## 📚 **関連ファイル**

- [extract_training_data_v2.py](https://github.com/aka209859-max/anonymous-keiba-ai/blob/genspark_ai_developer/extract_training_data_v2.py) - 過去走データ統合版
- [check_past_race_columns.py](https://github.com/aka209859-max/anonymous-keiba-ai/blob/genspark_ai_developer/check_past_race_columns.py) - カラム名確認スクリプト
- [docs/correction_past_race_data.md](https://github.com/aka209859-max/anonymous-keiba-ai/blob/genspark_ai_developer/docs/correction_past_race_data.md) - 過去走データの訂正ドキュメント

---

## まとめ

- ✅ **PC-KEIBAの実際のデータ構造を正しく理解**
- ✅ **ROW_NUMBER()を使用した過去走データ取得**
- ✅ **特徴量数: 18個 → 45個 に増加**
- ✅ **期待される精度向上: AUC 0.60-0.75 → 0.70-0.85**

**今すぐやること:**
```cmd
git pull origin genspark_ai_developer
python extract_training_data_v2.py --limit 1000 --output test_data_v2.csv
python extract_training_data_v2.py --keibajo 44 --start-date 2023 --end-date 2024 --output ooi_2023-2024_v3.csv
python train_development.py ooi_2023-2024_v3.csv
```

学習完了後、結果を報告してください！
