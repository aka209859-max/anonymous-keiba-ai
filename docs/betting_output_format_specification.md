# 馬券購入推奨システム - 完全版出力フォーマット仕様書

## 1. 概要

本仕様書は、Phase 5 アンサンブルモデルの予測結果をWebサービス・SNS配信用に整形するための出力フォーマットを定義する。

## 2. 基本方針

### 2.1 出力の前提条件
- **事前予測**: レース前日〜当日朝に買い目を生成・公開
- **オッズ依存処理**: 当日オッズ確定後にケリー基準で賭け金を最終決定
- **条件付き推奨**: 「オッズ○○倍以上なら推奨」の形式
- **フォーメーション対応**: 複数点をまとめて表示（1点買い禁止）

### 2.2 券種別の出力形式

#### 単勝・複勝
- **形式**: 個別馬番列挙
- **例**: 
  ```
  【単勝】6番（推奨オッズ: 2.5倍以上）
  【複勝】6番, 2番, 11番
  ```

#### 馬連・ワイド
- **形式**: 組み合わせ列挙 + 条件
- **例**:
  ```
  【馬連】
  ✅ 6-2（推奨オッズ: 5.0倍以上）
  ✅ 6-11（推奨オッズ: 7.0倍以上）
  ⚠️  2-11（オッズ3.0倍未満は購入非推奨）
  ```

#### 馬単
- **形式**: フォーメーション（軸-相手）
- **例**:
  ```
  【馬単フォーメーション】
  軸: 6番
  相手: 2, 11, 4（3点）
  展開: 6-2, 6-11, 6-4
  条件: 各組み合わせのオッズ8.0倍以上なら推奨
  ```

#### 三連複
- **形式**: ボックスまたはフォーメーション
- **例**:
  ```
  【三連複】
  ✅ ボックス: 6-2-11（1点）
     推奨オッズ: 15.0倍以上
  
  ✅ フォーメーション: 6-2-1.3.4.5（4点）
     軸: 6, 2（固定）
     3頭目: 1, 3, 4, 5
     展開: 6-2-1, 6-2-3, 6-2-4, 6-2-5
     条件: 各組み合わせのオッズ20.0倍以上なら推奨
  ```

#### 三連単
- **形式**: フォーメーション（1着-2着-3着）
- **例**:
  ```
  【三連単フォーメーション】
  1着: 6番
  2着: 2, 11
  3着: 2, 11, 4, 1（重複除外）
  展開: 6-2-11, 6-2-4, 6-2-1, 6-11-2, 6-11-4, 6-11-1（6点）
  条件: 各組み合わせのオッズ50.0倍以上なら推奨
  ```

または個別列挙形式:
  ```
  【三連単】
  ✅ 6-2-11（推奨オッズ: 50.0倍以上）
  ✅ 6-2-4（推奨オッズ: 60.0倍以上）
  ✅ 6-2-1（推奨オッズ: 80.0倍以上）
  ✅ 6-11-2（推奨オッズ: 55.0倍以上）
  ✅ 6-11-4（推奨オッズ: 70.0倍以上）
  ✅ 6-11-1（推奨オッズ: 90.0倍以上）
  ```

## 3. ケリー基準の事前対応方式

### 3.1 方式A: オッズ閾値テーブル（推奨）

```
【ワイド 6-2】
AI予測的中確率: 25.0%
期待値1.05達成の最低オッズ: 4.2倍

💡 オッズ4.2倍以上なら購入推奨

📊 オッズ別推奨賭け金（総資金10,000円の場合）:
   オッズ4.2倍 → 100円（期待値ギリギリ）
   オッズ6.0倍 → 250円（推奨）
   オッズ8.0倍 → 400円（積極）
   オッズ10.0倍以上 → 550円（最大）

⚠️  オッズ4.2倍未満の場合は購入非推奨
```

**実装コード**:
```python
def generate_kelly_table(predicted_prob, bankroll=10000, fraction=0.25):
    """ケリー基準のオッズ別賭け金テーブルを生成"""
    min_odds = 1.05 / predicted_prob
    
    kelly_table = []
    for odds_multiplier in [1.0, 1.5, 2.0, 2.5]:
        odds = min_odds * odds_multiplier
        # ケリー基準: f* = (p * b - q) / b
        # b = odds - 1, q = 1 - p
        kelly_fraction = (predicted_prob * odds - 1) / odds
        kelly_fraction = max(0, kelly_fraction * fraction)  # フラクショナル適用
        bet_amount = int(kelly_fraction * bankroll)
        
        kelly_table.append({
            'odds': odds,
            'bet_amount': bet_amount
        })
    
    return min_odds, kelly_table
```

### 3.2 方式B: 推定オッズによる事前計算

```
【ワイド 6-2】
AI予測的中確率: 25.0%
推定オッズ: 5.5倍（範囲: 4.2〜7.8倍）
※ 過去の類似レース42件の実績から推定

💰 推奨賭け金（推定オッズ5.5倍の場合）:
   保守的: 150円（ケリー係数0.25）
   推奨: 300円（ケリー係数0.25、オッズ上振れ期待）
   積極的: 600円（ケリー係数0.5、リスク高）

⚠️  当日オッズが4.0倍を下回る場合は購入見送り推奨
```

**実装コード**:
```python
def estimate_odds_from_history(combo, scores, history_db):
    """過去レースから当日オッズを推定"""
    similar_races = history_db.find_similar(
        score_pattern=scores,
        venue='大井',
        distance_range=(1200, 1800)
    )
    
    historical_odds = [r.get_odds(combo) for r in similar_races if r.get_odds(combo)]
    
    if historical_odds:
        return {
            'median': np.median(historical_odds),
            'q25': np.percentile(historical_odds, 25),
            'q75': np.percentile(historical_odds, 75)
        }
    else:
        # フォールバック: 単勝オッズから推定
        return estimate_from_win_odds(combo, scores)
```

### 3.3 方式C: リアルタイム更新（API連携）

**事前予測ページ（レース前日）**:
```
【ワイド 6-2】
予測的中確率: 25.0%
推奨条件: オッズ4.2倍以上
推定オッズ: 5.5倍

💡 推奨賭け金: 未確定
   → 当日10:00に確定オッズで更新

[オッズアラート設定] 📢
条件: オッズ4.2倍以上で通知
```

**当日更新ページ（締切10分前）**:
```
【ワイド 6-2】【更新: 14:50】
予測的中確率: 25.0%
確定オッズ: 6.2倍 ✅
期待値: 1.55

💰 推奨賭け金: 350円
   （総資金10,000円、ケリー係数0.25）

✅ 購入推奨（締切まで残り10分）
```

## 4. 完全版の出力テンプレート

### 4.1 レース単位の出力

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🏇 2025年12月31日 大井11R
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
レース名: 第XX回 XXXX賞
距離: 1,600m（ダート・左）
出走頭数: 12頭

【Phase 5 予測結果】
本命: 6番（ensemble_score: 0.82, Aランク）
対抗: 2番（ensemble_score: 0.71, Bランク）
単穴: 11番（ensemble_score: 0.65, Bランク）
連下: 4番（ensemble_score: 0.58, Cランク）

━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【推奨馬券】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【単勝】
✅ 6番（推奨度: ★★★★★）
   AI予測的中確率: 45.0%
   推奨オッズ: 2.5倍以上
   推定オッズ: 3.2倍（範囲: 2.8〜4.0倍）
   
   💰 推奨賭け金（総資金10,000円の場合）:
      オッズ2.5倍 → 500円
      オッズ3.0倍 → 800円
      オッズ3.5倍以上 → 1,000円

【複勝】
✅ 6番, 2番, 11番（推奨度: ★★★★☆）
   AI予測連対確率: 6番 73%, 2番 58%, 11番 52%
   💡 オッズ制限なし（堅実な投資）
   
   💰 推奨賭け金（総資金10,000円の場合）:
      各500円（計1,500円）

【馬連】
✅ 6-2（推奨度: ★★★★☆）
   AI予測的中確率: 32.0%
   推奨オッズ: 5.0倍以上
   推定オッズ: 6.8倍
   
✅ 6-11（推奨度: ★★★☆☆）
   AI予測的中確率: 28.0%
   推奨オッズ: 6.0倍以上
   推定オッズ: 8.2倍

⚠️  2-11（推奨度: ★☆☆☆☆）
   AI予測的中確率: 22.0%
   オッズ3.0倍未満は購入非推奨

   💰 推奨賭け金（総資金10,000円の場合）:
      6-2: 400円
      6-11: 300円

【ワイド】
✅ 6-2（推奨度: ★★★★☆）
   AI予測的中確率: 48.0%
   推奨オッズ: 2.5倍以上
   推定オッズ: 3.2倍
   
✅ 6-11（推奨度: ★★★☆☆）
   AI予測的中確率: 42.0%
   推奨オッズ: 3.0倍以上
   推定オッズ: 4.1倍

❌ 6-4, 2-11（推奨度: ★☆☆☆☆）
   ⚠️  期待値1.0未満の可能性あり

   💰 推奨賭け金（総資金10,000円の場合）:
      6-2: 300円
      6-11: 200円

【馬単フォーメーション】
軸: 6番
相手: 2, 11, 4（3点）
展開: 6-2, 6-11, 6-4

✅ 6-2（推奨度: ★★★★☆）
   AI予測的中確率: 25.0%
   推奨オッズ: 8.0倍以上
   推定オッズ: 10.5倍
   
✅ 6-11（推奨度: ★★★☆☆）
   AI予測的中確率: 20.0%
   推奨オッズ: 10.0倍以上
   推定オッズ: 13.2倍

⚠️  逆目（2-6, 11-6）は購入非推奨

   💰 推奨賭け金（総資金10,000円の場合）:
      6-2: 500円
      6-11: 400円
      6-4: 300円（計1,200円）

【三連複】
✅ ボックス: 6-2-11（1点）
   AI予測的中確率: 15.0%
   推奨オッズ: 15.0倍以上
   推定オッズ: 22.5倍
   
✅ フォーメーション: 6-2-1.3.4.5（4点）
   軸: 6, 2（固定）
   3頭目: 1, 3, 4, 5
   展開: 6-2-1, 6-2-3, 6-2-4, 6-2-5
   推奨オッズ: 各組み合わせ20.0倍以上
   推定オッズ範囲: 25.0〜45.0倍
   
   💰 高配当狙い（リスク: 中）

   💰 推奨賭け金（総資金10,000円の場合）:
      ボックス: 500円
      フォーメーション: 各200円（計800円）
      合計: 1,300円

【三連単フォーメーション】
1着: 6番
2着: 2, 11
3着: 2, 11, 4, 1（重複除外）
展開: 6-2-11, 6-2-4, 6-2-1, 6-11-2, 6-11-4, 6-11-1（6点）

✅ 6-2-11（推奨度: ★★★★☆）
   AI予測的中確率: 8.0%
   推奨オッズ: 50.0倍以上
   推定オッズ: 72.5倍
   
✅ 6-2-4（推奨度: ★★★☆☆）
   AI予測的中確率: 6.5%
   推奨オッズ: 60.0倍以上
   推定オッズ: 88.3倍

✅ 6-11-2（推奨度: ★★★☆☆）
   AI予測的中確率: 7.0%
   推奨オッズ: 55.0倍以上
   推定オッズ: 78.9倍

   💰 高配当狙い（リスク: 高）

   💰 推奨賭け金（総資金10,000円の場合）:
      各600円（計3,600円）

━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【購入非推奨の組み合わせ】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
❌ 単勝: 2番, 11番（期待値1.0未満）
❌ ワイド: 人気上位同士（1-2, 1-3等）
❌ 馬連: オッズ3.0倍未満の全組み合わせ

━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【資金配分の目安】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
総資金: 10,000円の場合

券種        | 推奨金額 | 点数 | 期待値
-----------|---------|------|--------
単勝       | 1,000円 | 1点  | 1.44
複勝       | 1,500円 | 3点  | 1.15
馬連       | 700円   | 2点  | 1.28
ワイド     | 500円   | 2点  | 1.22
馬単       | 1,200円 | 3点  | 1.38
三連複     | 1,300円 | 5点  | 1.45
三連単     | 3,600円 | 6点  | 1.52
-----------|---------|------|--------
合計       | 9,800円 | 22点 | 1.41

⚠️  実際の購入金額は当日オッズを確認後、
    期待値1.05以上の組み合わせのみに絞ってください。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【重要事項】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
1. 上記の推奨金額は「推定オッズ」に基づく目安です
2. 当日の確定オッズが推奨オッズを下回る場合は購入を見送ってください
3. 期待値1.05未満の馬券は購入非推奨です
4. 総資金の10%以内に収まるよう調整してください

━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

## 5. 実装時の注意事項

### 5.1 フォーメーション展開の実装

```python
def generate_sanrentan_formation(axis, second_list, third_list):
    """
    三連単フォーメーションを展開
    
    Parameters:
    - axis: 1着固定馬（例: 6）
    - second_list: 2着候補（例: [2, 11]）
    - third_list: 3着候補（例: [2, 11, 4, 1]）
    
    Returns:
    - 全組み合わせのリスト（重複除外）
    """
    combinations = []
    for second in second_list:
        for third in third_list:
            # 重複チェック
            if axis != second and axis != third and second != third:
                combinations.append((axis, second, third))
    return combinations

# 出力例
axis = 6
second = [2, 11]
third = [2, 11, 4, 1]
combos = generate_sanrentan_formation(axis, second, third)
print(f"展開: {', '.join([f'{c[0]}-{c[1]}-{c[2]}' for c in combos])}")
# 出力: 展開: 6-2-11, 6-2-4, 6-2-1, 6-11-2, 6-11-4, 6-11-1
```

### 5.2 推定オッズの計算

```python
def estimate_odds_for_combo(combo, ensemble_scores, bet_type):
    """
    馬券の組み合わせに対する推定オッズを計算
    
    Parameters:
    - combo: 馬番の組み合わせ（例: (6, 2)）
    - ensemble_scores: 各馬のAIスコア辞書
    - bet_type: 券種（'wide', 'umaren', 'umatan', 'sanrenpuku', 'sanrentan'）
    
    Returns:
    - 推定オッズ
    """
    # 単勝オッズから推定（簡易版）
    # 実際の実装では過去の類似レースデータを使用
    
    if bet_type in ['wide', 'umaren']:
        # 2頭の単勝オッズの積の平方根
        odds1 = estimate_win_odds(combo[0], ensemble_scores)
        odds2 = estimate_win_odds(combo[1], ensemble_scores)
        estimated = (odds1 * odds2) ** 0.5
        
    elif bet_type == 'umatan':
        # 馬単は馬連の1.5〜2倍
        umaren_odds = estimate_odds_for_combo(combo, ensemble_scores, 'umaren')
        estimated = umaren_odds * 1.7
        
    elif bet_type == 'sanrenpuku':
        # 3頭の単勝オッズの積の立方根
        odds1 = estimate_win_odds(combo[0], ensemble_scores)
        odds2 = estimate_win_odds(combo[1], ensemble_scores)
        odds3 = estimate_win_odds(combo[2], ensemble_scores)
        estimated = (odds1 * odds2 * odds3) ** (1/3)
        
    elif bet_type == 'sanrentan':
        # 三連単は三連複の3〜5倍
        sanrenpuku_odds = estimate_odds_for_combo(combo, ensemble_scores, 'sanrenpuku')
        estimated = sanrenpuku_odds * 4
    
    return round(estimated, 1)

def estimate_win_odds(umaban, ensemble_scores):
    """単勝オッズの推定（簡易版）"""
    score = ensemble_scores.get(umaban, 0.5)
    # スコアが高いほどオッズは低い
    # 経験則: odds ≈ 1 / (score + 0.1)
    estimated_odds = 1.0 / (score + 0.1)
    return max(1.1, estimated_odds)  # 最低1.1倍
```

### 5.3 期待値とケリー基準の計算

```python
def calculate_ev_and_kelly(predicted_prob, odds, fraction=0.25):
    """
    期待値とケリー基準の賭け金比率を計算
    
    Parameters:
    - predicted_prob: AI予測の的中確率
    - odds: オッズ
    - fraction: フラクショナル係数（デフォルト0.25）
    
    Returns:
    - ev: 期待値
    - kelly_fraction: 最適賭け金比率
    - min_odds_required: 期待値1.05を達成する最低オッズ
    """
    # 期待値
    ev = predicted_prob * odds
    
    # 最低オッズ
    min_odds_required = 1.05 / predicted_prob
    
    # ケリー基準
    if odds < min_odds_required:
        kelly_fraction = 0.0  # 購入非推奨
    else:
        # f* = (p * b - q) / b
        # b = odds - 1, q = 1 - p
        kelly_fraction = (predicted_prob * odds - 1) / odds
        kelly_fraction = max(0, kelly_fraction * fraction)  # フラクショナル適用
    
    return {
        'ev': ev,
        'kelly_fraction': kelly_fraction,
        'min_odds_required': min_odds_required
    }
```

## 6. SNS配信用の簡略版フォーマット

### 6.1 Twitter/X 用（140文字制限）

```
🏇大井11R
本命❶6番
▲2番 ▲11番
【推奨】
単勝6番(3倍↑)
馬単6-2(8倍↑)
三連単6-2.11-全(50倍↑)

詳細→ [リンク]
#大井競馬 #AI予想
```

### 6.2 Instagram/Facebook 用

```
🏇 2025/12/31 大井11R Phase 5予想

【本命】❶6番（Aランク）
【対抗】▲2番（Bランク）
【単穴】▲11番（Bランク）

━━━━━━━━━━━━━━━
💡 推奨馬券
━━━━━━━━━━━━━━━
✅ 単勝: 6番（3倍以上）
✅ 複勝: 6,2,11
✅ 馬単: 6-2,11,4（8倍以上）
✅ 三連単: 6-2.11-全（50倍以上）

⚠️  オッズが条件を下回る場合は購入見送り

詳細な買い目・推奨賭け金は
プロフィールのリンクから👇

#大井競馬 #AI競馬予想 #Phase5
```

## 7. まとめ

本仕様書に基づき、以下の実装を推奨する:

1. **事前予測エンジン**: レース前日に買い目を生成
2. **推定オッズ計算**: 過去データから当日オッズを推定
3. **ケリー基準テーブル**: オッズ別の推奨賭け金を事前計算
4. **フォーメーション展開**: 複数点をわかりやすく表示
5. **リアルタイム更新**: 当日オッズ確定後に最終推奨を更新

これにより、ユーザーは「条件を満たす場合のみ購入」という明確な指針を得ることができ、Webサービス・SNS配信に最適化された情報提供が可能となる。
