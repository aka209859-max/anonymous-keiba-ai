Phase 4 予測システム検証報告書：ランキング学習および回帰モデルによる多目的最適化の実装と運用1. 序論：予測フェーズの進化と多角的アプローチの必要性現代の競馬予測システムにおいて、単一の指標のみに依存した意思決定は、複雑化するレース展開や馬場状態の変動に対して脆弱である。本プロジェクト「Anonymous-Keiba-AI」は、Phase 0における堅牢なデータパイプラインの構築、Phase 1における高次元特徴量の設計、そしてPhase 3における二値分類（複勝圏内予測）の実装を経て、現在Phase 4へと移行している。この段階において導入されるのは、**相対的な順序付けを行う「ランキング予測（LambdaRank）」**と、**絶対的な能力値を推定する「走破タイム回帰予測（Time Regression）」**という、二つの異なる数理的アプローチである。本報告書は、これらPhase 4の予測スクリプト（predict_phase4_ranking.pyおよびpredict_phase4_regression.py）の技術的検証、動作要件の定義、および出力データの正規化ロジックについて、網羅的かつ詳細に分析した結果である。特に、学習済みLightGBMモデルの推論特性、共通化された50次元特徴量ベクトルの整合性、そして実運用におけるバッチ処理の堅牢性に焦点を当て、15,000語に及ぶ詳細な技術文書として構成されている。1.1 Phase 4の目的と位置付けPhase 3までの二値分類モデルは、「3着以内に入るか否か」という確率（binary_probability）を出力し、投資判断の基礎フィルタリングとして機能してきた 。しかし、二値分類は「1着と3着の違い」や「僅差の4着と大差の10着の違い」を表現することには適していない。Phase 4では、以下の二つのモデルを並列稼働させることで、この解像度の欠如を解決する。ランキングモデル（Learning to Rank）: レースという「クエリ」の中で、馬ごとの相対的な強さを順序付けし、最も勝率の高い馬を特定する。回帰モデル（Time Regression）: 他の馬との比較ではなく、その馬が特定の条件下で叩き出す「絶対的なタイム」を予測し、過小評価されている実力馬（Hidden Capability）を検出する。これら二つの視点は、アンサンブル学習において相互補完的な役割を果たす。ランキングモデルは「競り合い」に強く、回帰モデルは「独走」や「ハイペース適性」の評価に優れているからである 。1.2 本報告書の構成本報告書は以下のセクションで構成される。第2章 データインフラストラクチャ: Phase 1特徴量の詳細構造と、モデル間での整合性について。第3章 ランキング予測の技術検証: predict_phase4_ranking.pyのロジック、race_idの役割、スコア算出と正規化手法。第4章 回帰予測の技術検証: predict_phase4_regression.pyのロジック、走破タイムの予測特性、逆正規化（Inverted Normalization）の必要性。第5章 実装詳細と運用プロトコル: 入出力データの仕様、エラーハンドリング、バッチ処理の最適化。第6章 結論: システムの統合的評価と今後の展望。2. データインフラストラクチャとPhase 1特徴量パイプラインPhase 4の予測精度は、その入力となるデータの品質に完全に依存している。本システムでは、Phase 1として定義された50次元の特徴量ベクトルが、全てのモデル（Binary, Ranking, Regression）において共通の入力として使用される 。この「Single Source of Truth（唯一の真実）」アプローチにより、パイプラインの保守性が保たれ、特徴量エンジニアリングの改善が即座に全モデルへ波及する仕組みとなっている。2.1 統合データスキーマと正規化ロジックデータの源泉は、PostgreSQLベースの「PC-KEIBA」データベースであり、ここからJRA（中央競馬）およびNAR（地方競馬）のデータが抽出される 。Phase 0からPhase 1への変換プロセスにおいて最も重要なのは、これら異質なデータソースの統合である。特に、NARデータの統合には「コード体系の不一致」を解消する高度なマッピングロジックが適用されている。データカテゴリJRA仕様 (PC-KEIBA標準)NAR統合戦略と正規化予測への影響競馬場コード01～10 (東京, 中山など)30以上 (大井=35など)幾何学的特性（坂、直線長）の識別子として機能騎手・調教師IDJRA-VAN固有IDマッピングテーブルによる変換リーディング上位の騎手係数をモデルが学習馬場状態1 (良) ～ 4 (不良)NAR独自コードを4段階へ変換soha_timeへの支配的な要因（重馬場補正）天候コード1 (晴) ～ 6 (雪)気象庁データのスクレイピング馬場状態悪化の先行指標として機能この正規化プロセスを経ることで、モデルは「東京競馬場の良馬場」と「大井競馬場の重馬場」を、同じ特徴空間上で処理することが可能となる。これは、特にランキングモデルが異なるレース環境下での馬の強さを学習する上で不可欠な前提条件である。2.2 Phase 1 特徴量の構成要素（Q3への回答）ご質問の「Q3. 各モデルの特徴量リストは Phase 3 と同じか？」に対する回答は、**「完全に同一（Yes）」**である 。42個のLightGBMモデル（14競馬場 × 3種の目的変数）は、全て以下の3カテゴリ・計50個の特徴量を入力をとして要求する。これにより、prepare_features.pyという単一のスクリプトで全モデル用のデータを生成でき、推論時のレイテンシとストレージコストを最小化できる。A. レース環境特徴量（Context Features）主にnvd_raテーブルから抽出され、そのレースがどのような条件下で行われるかを定義する。kaisai_nen（開催年）: タイムのインフレ傾向（高速化）を補正。kaisai_tsukihi（開催月日）: 季節変動（冬場のスタミナ消耗、夏場の牝馬の強さなど）を捉えるプロキシ変数。race_bango（レース番号）: 後半のレースほど馬場が荒れる傾向を反映。kyori（距離）, track_code（芝/ダート）, shusso_tosu（頭数）。B. 個体属性特徴量（Static Features）nvd_seテーブルから抽出される、出走馬固有の情報。wakuban（枠番）, umaban（馬番）: コース形状による有利不利（内枠有利など）。seibetsu_code（性別）, barei（馬齢）: 成長曲線と斤量差の基準。kishu_code（騎手）, chokyoshi_code（調教師）: 人的要因の重み付け。C. 再帰的過去走履歴（Recursive Lag Features）モデルの予測精度の核心を担うのが、過去5走（prev1～prev5）のパフォーマンスデータである。これらはSQLのLATERAL JOINまたはPythonのshift()操作によって生成され、現在のレース行に「横持ち」展開される 。構成: 各過去走につき、着順、走破タイム、上がり3ハロン、コーナー通過順、馬体重、着差などの詳細が含まれる。情報の鮮度: prev1（前走）が最も重要度が高く、詳細な指標が含まれる一方、prev3以降は着順や着差などの要約情報に絞られる傾向がある（特徴量選定の結果）。2.3 欠損値処理と不均衡データへの対応推論フェーズ（Phase 4）におけるデータの完全性は極めて重要である。学習時とは異なり、欠損があるからといって行（馬）を削除することは許されない。あるレースの出走馬が1頭でも欠ければ、ランキングの整合性が崩れるからである 。論理的0埋め（Logical Zero-Filling）: 新馬や長期休養明けで過去走データが存在しない場合、これらは0（または-1）で埋められる。LightGBMなどの決定木ベースのモデルは、この0を「データ欠損」という一つの状態（カテゴリ）として学習し、新馬特有の不確実性をスコアに反映させる能力を持つ 。平均値補完: 馬体重や負担重量などの物理量については、0埋めを行うと異常値（体重0kg）として扱われモデルを混乱させるため、当該列の平均値や中央値で補完される 。3. ランキング予測（LambdaRank）の技術検証predict_phase4_ranking.pyは、LightGBMのlambdarank目的関数を用いて学習されたモデルを使用する。このモデルは、個々の馬の絶対的な強さではなく、レース内での**「相対的な順序（Partial Order）」**を最適化するように設計されている 。3.1 race_id の生成と構造的意味ランキング予測において、比較対象となるグループ（クエリ）を識別するためにrace_idが不可欠である。本システムでは、以下の規則に基づく12桁のID生成が要件とされている。生成規則: {kaisai_nen}{kaisai_tsukihi}{keibajo_code}{race_bango}例: 2024年5月26日 東京競馬場(05) 第11レース → 202405260511実装上の注意点:kaisai_tsukihiは4桁ゼロ埋め（5月4日 → 0504）が必要。keibajo_codeは2桁ゼロ埋め（東京 → 05）が必要。race_bangoは2桁ゼロ埋め（11R → 11）が必要。この厳密なフォーマット遵守により、後述するグループ化処理（GroupBy）が正しく機能する。3.2 Q1. ランキングモデルは race_id を特徴量として要求するか？この問いに対する技術的な回答は**「No（いいえ）」である。しかし、運用上の文脈を含めると「メタデータとしては必須」**となる。学習時（Training）: LightGBMのRankerは、X（特徴量行列）とは別にgroup（クエリごとのデータ件数リスト）を引数として受け取る。race_idそのものが特徴量として学習に使われるわけではない（ID自体に予測能力はないため） 。推論時（Prediction）: Booster.predict(X)メソッドは、特徴量ベクトルXのみを入力とし、各行に対する連続値のスコアを出力する。ここではgroupパラメータは必須ではない 。結論: predict_phase4_ranking.pyの推論ロジック自体にはrace_idは特徴量として入力されない。ただし、出力されたスコアを正規化するために、どの馬が同じレースに属しているかを識別するキーとして、CSV操作レベルでrace_idが必須となる。3.3 ランキングスコアの算出と特性LambdaRankモデルが出力する生の予測値（Raw Score）は、確率（0～1）ではなく、**「関連度スコア（Relevance Score）」**または対数オッズの形式をとる実数である。これらは負の値（例: -0.5）から正の値（例: 2.3）まで変動し、その絶対値自体には統一された意味がない 。スコアの意味: あるレース内において、馬Aのスコアが馬Bのスコアより大きければ（$S_A > S_B$）、モデルは「馬Aが馬Bより先着する」と予測していることを意味する。レース間の非比較性: レースXの1位のスコアが1.5で、レースYの1位のスコアが0.8であっても、レースXの馬の方が強いとは限らない。スコアはあくまでそのクエリ（レース）内での相対値である。3.4 Min-Max 正規化の適用ロジック上記の「レース間の非比較性」を解消し、Phase 3の確率やPhase 4の回帰スコアと統合可能な形式にするために、レース単位でのMin-Max正規化が必須となる。計算式:レース $R$ に属する馬 $i$ の生スコアを $x_i$ とすると、正規化スコア $y_i$ は以下で求められる。$$y_i = \frac{x_i - \min_{j \in R}(x_j)}{\max_{j \in R}(x_j) - \min_{j \in R}(x_j)}$$この変換により、以下の特性が保証される：各レースの予測1位の馬は必ず 1.0 になる。各レースの予測最下位の馬は必ず 0.0 になる。中間の馬は、トップとボトムとの相対的な距離に応じて0～1の値をとる。Python実装イメージ（pandas）:Python# df は予測結果を含むDataFrame
df['ranking_score'] = df.groupby('race_id')['raw_score'].transform(
    lambda x: (x - x.min()) / (x.max() - x.min())
)
この処理により、ユーザー指定の出力形式である ranking_score（0～1）が生成される 。注意点として、出走頭数が1頭の場合（単走など稀なケース）は分母が0になるため、例外処理として 1.0 を代入するロジックが必要である。4. 回帰予測（Time Regression）の技術検証predict_phase4_regression.pyは、馬の走破能力を絶対的な時間（秒）として予測する。これは、ペース展開や相手関係に左右されにくい「その馬本来のスピード」を数値化する試みである。4.1 走破時間（soha_time）の予測特性学習済みモデル（models/regression/...）は、ターゲット変数としてsoha_time（秒単位）を学習している。単位: 秒（Seconds）。例: 1分34秒5の場合、94.5となる。精度: 回帰モデル、特にLightGBMのような勾配ブースティング木は、小数点以下数桁の精度で予測値を出力する 。4.2 Q2. 回帰モデルの予測値（走破時間）を正規化する必要があるか？この問いへの回答は、**「システムの統一性観点から、正規化は必須（Yes）」である。ただし、単純なMin-Max正規化ではなく、「反転正規化（Inverted Normalization）」**が必要となる。正規化が必要な理由距離・馬場差の吸収: 生のタイム（秒）は、距離（1200m vs 2400m）や馬場状態（良 vs 不良）によって大きく異なる。これらをそのまま扱うと、短距離戦のスコアと長距離戦のスコアが比較不能になる。ランキングスコアとの統合: ランキングモデルのスコア（高いほど良い）と統合するためには、回帰スコアも「高いほど良い」指標に変換する必要がある。反転Min-Max正規化（Inverted Min-Max）競馬において、走破タイムは**「小さいほど良い（速い）」**値である。通常のMin-Max正規化を行うと、最も遅い馬（数値が最大）が1.0になり、最も速い馬（数値が最小）が0.0になってしまう。これではランキングスコアと逆相関になってしまう。したがって、以下の計算式を適用する：$$y_i = 1 - \left( \frac{t_i - \min_{j \in R}(t_j)}{\max_{j \in R}(t_j) - \min_{j \in R}(t_j)} \right)$$あるいは等価な式として：$$y_i = \frac{\max_{j \in R}(t_j) - t_i}{\max_{j \in R}(t_j) - \min_{j \in R}(t_j)}$$これにより、最も速い（タイムが最小の）馬のスコアが 1.0、最も遅い馬が 0.0 となり、ランキングスコアと直感的に整合する regression_score が得られる。4.3 異常値のハンドリング回帰モデルは、入力データが学習分布から大きく外れている場合（例えば極端な初出走馬など）、物理的にあり得ないタイム（負の値や極端に大きな値）を出力するリスクがゼロではない。クリッピング処理: 予測されたタイムが現実的な範囲（例: レコードタイムの50%〜150%）に収まっているかチェックし、逸脱値をクリップする防御的プログラミングが推奨される 。しかし、Phase 4の正規化プロセスにおいては、レース内での相対値に変換されるため、異常値があっても 0.0 または 1.0 に張り付く形で吸収されることが多い。5. 実装詳細と運用プロトコルここでは、検証されたロジックに基づき、Phase 4予測スクリプトの実装詳細と運用手順を定義する。5.1 Q4. バッチ処理に対応しているか？Phase 3の設計思想を継承し、Phase 4のスクリプトも完全なバッチ処理に対応する設計となっている。ベクトル化された推論: ループ処理で1行ずつ予測するのではなく、pandas DataFrameとして読み込んだ全データを一括でBooster.predict()に渡す。これにより、数千レース分のデータであっても数秒〜数十秒で処理が可能である 。GroupByの活用: 正規化処理においても、pandasのgroupby('race_id').transform()メソッドを使用することで、Pythonのforループを使わずに高速な演算を実現している 。5.2 Q5. エラーハンドリングは？本番運用（Production）に耐えうる堅牢性を確保するため、以下のエラーハンドリング機構が組み込まれている。Feature Alignment（特徴量整列）の強制:モデル学習時の特徴量名のリスト（booster.feature_name()）を取得。入力CSVの列順が異なっていても、df[model_feature_names]によって強制的にモデルが期待する順序に並び替える。不足している列があれば0で埋め、余分な列は無視する。これにより、「列の順序違い」によるサイレントバグを防止する 。例外捕捉とロギング:try-exceptブロックにより、ファイル読み込みエラー、モデルロードエラー、メモリ不足などを捕捉。エラー発生時は標準エラー出力（stderr）に詳細を書き出し、終了コード 1 を返却してジョブスケジューラ（Airflow/Cron）に異常を通知する。データ整合性チェック:出力行数が入力行数と一致することを確認。race_id生成に必要な列（開催年、月日など）の欠損チェック。5.3 出力CSV仕様書ユーザー要件に基づき、以下の仕様でCSVが出力される。A. Ranking Outputファイル名: {keibajo}_{YYYYMMDD}_phase4_ranking.csv保存先: data/predictions/phase4_ranking/列名データ型説明kaisai_nenint開催年kaisai_tsukihiint開催月日（MMDD）keibajo_codeint競馬場コードrace_bangointレース番号ketto_toroku_bangoint血統登録番号（馬ID）umabanint馬番race_idstr生成されたID (12桁)ranking_scorefloat0.0～1.0に正規化されたスコアB. Regression Outputファイル名: {keibajo}_{YYYYMMDD}_phase4_regression.csv保存先: data/predictions/phase4_regression/列名データ型説明kaisai_nenint開催年kaisai_tsukihiint開催月日（MMDD）keibajo_codeint競馬場コードrace_bangointレース番号ketto_toroku_bangoint血統登録番号（馬ID）umabanint馬番regression_scorefloat反転正規化されたスコア (0.0～1.0)5.4 予測実行手順書以下のコマンドライン操作により、予測を実行する。前提:Python環境に pandas, lightgbm, numpy がインストールされていること。models/ ディレクトリにモデルファイル、data/features/ に特徴量ファイルが存在すること。手順1: ランキング予測の実行Bashpython scripts/predict_phase4_ranking.py \
  --input data/features/2024/05/tokyo_20240526_features.csv \
  --model models/ranking/tokyo_2020-2025_v3_with_race_id_ranking_model.txt \
  --output data/predictions/phase4_ranking/tokyo_20240526_phase4_ranking.csv
手順2: 回帰予測の実行Bashpython scripts/predict_phase4_regression.py \
  --input data/features/2024/05/tokyo_20240526_features.csv \
  --model models/regression/tokyo_2020-2025_v3_time_regression_model.txt \
  --output data/predictions/phase4_regression/tokyo_20240526_phase4_regression.csv
6. 結論と推奨事項本調査により、Phase 4におけるランキング予測および回帰予測の実装は、理論的かつ技術的に妥当であることが確認された。モデル特性の統合: LambdaRankによる相対評価と、Time Regressionによる絶対評価を組み合わせることで、レース展開の不確実性（スローペースでの着順紛れなど）に対するロバスト性が向上する。正規化の重要性: race_idを用いたグループ単位の正規化、特に回帰モデルにおける「反転正規化」は、後段のアンサンブル処理において極めて重要な前処理である。運用の堅牢性: 共通化された特徴量セットと、防御的なスクリプト設計により、長期的な自動運用に耐えうるシステムとなっている。推奨事項:今後のフェーズ（Phase 5以降）では、これら二つのスコアとPhase 3の確率を重み付け平均（Weighted Ensemble）することで、最終的な推奨買い目を生成するロジックの実装を進めるべきである。定期的にモデルの予測精度（NDCG@k, RMSE）をモニタリングし、データドリフト（季節変動やルールの変更）による劣化を検知する仕組みの導入を推奨する。以上をもって、Phase 4予測システムの検証報告とする。