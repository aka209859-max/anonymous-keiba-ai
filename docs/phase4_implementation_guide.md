# Phase 4 å®Ÿè£…ã‚¬ã‚¤ãƒ‰: 3ã¤ã®ç‰¹åŒ–ãƒ¢ãƒ‡ãƒ«ã¨ã‚¢ãƒ³ã‚µãƒ³ãƒ–ãƒ«

**ä½œæˆæ—¥**: 2026-02-04  
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 4 - ãƒ¢ãƒ‡ãƒ«æ´¾ç”Ÿã¨ã‚¢ãƒ³ã‚µãƒ³ãƒ–ãƒ«çµ±åˆ

---

## ğŸ“‹ æ¦‚è¦

Phase 4 ã§ã¯ã€Phase 3 ã§æ§‹ç¯‰ã—ãŸäºŒå€¤åˆ†é¡ãƒ¢ãƒ‡ãƒ«ã‚’åŸºã«ã€3ã¤ã®ç‰¹åŒ–ãƒ¢ãƒ‡ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸï¼š

1. **ãƒ©ãƒ³ã‚­ãƒ³ã‚°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«** (`train_ranking_model.py`)
2. **å›å¸°åˆ†æãƒ¢ãƒ‡ãƒ«** (`train_regression_model.py`)
3. **ã‚¢ãƒ³ã‚µãƒ³ãƒ–ãƒ«çµ±åˆ** (`ensemble_model.py`)

ã“ã‚Œã‚‰ã®ãƒ¢ãƒ‡ãƒ«ã¯ã€åŒã˜ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ä½¿ç”¨ã—ãªãŒã‚‰ã€ç•°ãªã‚‹ã€Œæ­£è§£ã€ã‚’å­¦ç¿’ã™ã‚‹ã“ã¨ã§ã€å¤šè§’çš„ãªäºˆæ¸¬ã‚’å®Ÿç¾ã—ã¾ã™ã€‚

---

## ğŸ¯ å„ãƒ¢ãƒ‡ãƒ«ã®ç›®çš„ã¨ç‰¹å¾´

### 1. ãƒ©

ãƒ³ã‚­ãƒ³ã‚°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ï¼ˆLightGBM Rankerï¼‰

**ãƒ•ã‚¡ã‚¤ãƒ«**: `train_ranking_model.py`

#### ç›®çš„
- ãƒ¬ãƒ¼ã‚¹å†…ã®ç›¸å¯¾é †ä½ã‚’å­¦ç¿’
- ã€ŒAé¦¬ã¯Bé¦¬ã‚ˆã‚Šå¼·ã„ã‹ï¼Ÿã€ã¨ã„ã†ç›¸å¯¾è©•ä¾¡

#### ä¸»ãªå¤‰æ›´ç‚¹ï¼ˆtrain_development.py ã‹ã‚‰ã®å·®åˆ†ï¼‰
```python
# objective ã¨ metric ã®å¤‰æ›´
params = {
    'objective': 'lambdarank',  # äºŒå€¤åˆ†é¡ã® 'binary' ã‹ã‚‰å¤‰æ›´
    'metric': 'ndcg',           # 'auc' ã‹ã‚‰å¤‰æ›´
    'ndcg_eval_at': [1, 3, 5, 10],
    ...
}

# groupæƒ…å ±ã®è¿½åŠ ï¼ˆãƒ¬ãƒ¼ã‚¹IDã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ï¼‰
train_groups = race_ids_train.value_counts().sort_index().values
lgb_train = lgb.Dataset(X_train, y_train, group=train_groups)
```

#### å¿…é ˆè¦ä»¶
- **race_id ã‚«ãƒ©ãƒ **: ãƒ¬ãƒ¼ã‚¹ã‚’ä¸€æ„ã«è­˜åˆ¥ã™ã‚‹IDï¼ˆå¿…é ˆï¼‰
- **target ã‚«ãƒ©ãƒ **: ç€é †ï¼ˆ1ä½=1, 2ä½=2, ...ï¼‰
- **GroupShuffleSplit**: ãƒ¬ãƒ¼ã‚¹å˜ä½ã§ãƒ‡ãƒ¼ã‚¿åˆ†å‰²

#### ä½¿ç”¨æ³•
```bash
# åŸºæœ¬çš„ãªä½¿ã„æ–¹
python train_ranking_model.py <csvãƒ•ã‚¡ã‚¤ãƒ«å>

# ç‰¹å¾´é‡ãƒªã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šï¼ˆäºŒå€¤åˆ†é¡ã§é¸å®šã•ã‚ŒãŸç‰¹å¾´é‡ã‚’ä½¿ç”¨ï¼‰
python train_ranking_model.py <csvãƒ•ã‚¡ã‚¤ãƒ«å> <ç‰¹å¾´é‡ãƒªã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«>
```

#### å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«
- `{csv_file}_ranking_model.txt`: å­¦ç¿’æ¸ˆã¿ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ¢ãƒ‡ãƒ«
- `{csv_file}_ranking_model.png`: ç‰¹å¾´é‡é‡è¦åº¦ã‚°ãƒ©ãƒ•
- `{csv_file}_ranking_score.txt`: è©•ä¾¡æŒ‡æ¨™ï¼ˆNDCG@1, @3, @5, @10ï¼‰

---

### 2. å›å¸°åˆ†æãƒ¢ãƒ‡ãƒ«ï¼ˆLightGBM Regressorï¼‰

**ãƒ•ã‚¡ã‚¤ãƒ«**: `train_regression_model.py`

#### ç›®çš„
- èµ°ç ´ã‚¿ã‚¤ãƒ ã‚’äºˆæ¸¬ï¼ˆèƒ½åŠ›æŒ‡æ•°ã®ä»£æ›¿ï¼‰
- æ•°å€¤ã¨ã—ã¦èƒ½åŠ›ã‚’è©•ä¾¡

#### ä¸»ãªå¤‰æ›´ç‚¹ï¼ˆtrain_development.py ã‹ã‚‰ã®å·®åˆ†ï¼‰
```python
# objective ã¨ metric ã®å¤‰æ›´
params = {
    'objective': 'regression',  # 'binary' ã‹ã‚‰å¤‰æ›´
    'metric': 'rmse',           # 'auc' ã‹ã‚‰å¤‰æ›´
    ...
}

# è©•ä¾¡æŒ‡æ¨™ã®å¤‰æ›´
rmse = np.sqrt(mean_squared_error(y_test, y_pred))
mae = mean_absolute_error(y_test, y_pred)
r2 = r2_score(y_test, y_pred)
```

#### å¿…é ˆè¦ä»¶
- **target ã‚«ãƒ©ãƒ **: èµ°ç ´ã‚¿ã‚¤ãƒ ï¼ˆç§’ï¼‰ã¾ãŸã¯ã‚¿ã‚¤ãƒ æŒ‡æ•°
- ç›®çš„å¤‰æ•°ã¯é€£ç¶šå€¤ï¼ˆæ•°å€¤ï¼‰

#### ä½¿ç”¨æ³•
```bash
# åŸºæœ¬çš„ãªä½¿ã„æ–¹
python train_regression_model.py <csvãƒ•ã‚¡ã‚¤ãƒ«å>

# ç‰¹å¾´é‡ãƒªã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®š
python train_regression_model.py <csvãƒ•ã‚¡ã‚¤ãƒ«å> <ç‰¹å¾´é‡ãƒªã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«>
```

#### å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«
- `{csv_file}_regression_model.txt`: å­¦ç¿’æ¸ˆã¿å›å¸°ãƒ¢ãƒ‡ãƒ«
- `{csv_file}_regression_model.png`: ç‰¹å¾´é‡é‡è¦åº¦ã‚°ãƒ©ãƒ•
- `{csv_file}_regression_score.txt`: è©•ä¾¡æŒ‡æ¨™ï¼ˆRMSE, MAE, RÂ²ï¼‰

---

### 3. ã‚¢ãƒ³ã‚µãƒ³ãƒ–ãƒ«çµ±åˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `ensemble_model.py`

#### ç›®çš„
- 3ã¤ã®ãƒ¢ãƒ‡ãƒ«ã®äºˆæ¸¬ã‚’çµ±åˆã—ã¦æœ€çµ‚åˆ¤æ–­
- å„ãƒ¢ãƒ‡ãƒ«ã®å¼·ã¿ã‚’çµ„ã¿åˆã‚ã›ã‚‹

#### ã‚¢ãƒ³ã‚µãƒ³ãƒ–ãƒ«æˆ¦ç•¥
```python
# 1. å„äºˆæ¸¬å€¤ã‚’0-1ã®ç¯„å›²ã«æ­£è¦åŒ–
binary_norm = binary_proba  # æ—¢ã«0-1
ranking_norm = (ranking_score - min) / (max - min)
regression_norm = 1 - ((regression_time - min) / (max - min))  # åè»¢

# 2. åŠ é‡å¹³å‡ã§ç·åˆã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—
ensemble_score = (
    0.3 * binary_norm +      # äºŒå€¤åˆ†é¡: 3ç€ä»¥å†…ã®ç¢ºç‡
    0.5 * ranking_norm +     # ãƒ©ãƒ³ã‚­ãƒ³ã‚°: ç›¸å¯¾çš„ãªå¼·ã•
    0.2 * regression_norm    # å›å¸°: ã‚¿ã‚¤ãƒ äºˆæ¸¬ï¼ˆåè»¢ï¼‰
)

# 3. æ¨å¥¨åº¦ã‚’å‰²ã‚Šå½“ã¦
if binary_proba < 0.4:
    recommendation = 'æ¶ˆå»'
elif ensemble_score >= 0.7:
    recommendation = 'â— æœ¬å‘½'
elif ensemble_score >= 0.6:
    recommendation = 'â—‹ å¯¾æŠ—'
# ...
```

#### ä½¿ç”¨æ³•
```bash
# åŸºæœ¬çš„ãªä½¿ã„æ–¹
python ensemble_model.py <csvãƒ•ã‚¡ã‚¤ãƒ«> \
    <binary_model.txt> \
    <ranking_model.txt> \
    <regression_model.txt>

# é‡ã¿ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
python ensemble_model.py <csvãƒ•ã‚¡ã‚¤ãƒ«> \
    <binary_model.txt> \
    <ranking_model.txt> \
    <regression_model.txt> \
    --binary-weight 0.3 \
    --ranking-weight 0.5 \
    --regression-weight 0.2 \
    --threshold 0.4 \
    --output ensemble_predictions.csv
```

#### å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«
- `ensemble_predictions.csv`: ã‚¢ãƒ³ã‚µãƒ³ãƒ–ãƒ«äºˆæ¸¬çµæœ
  - å„ãƒ¢ãƒ‡ãƒ«ã®äºˆæ¸¬å€¤
  - æ­£è¦åŒ–ã‚¹ã‚³ã‚¢
  - ç·åˆã‚¹ã‚³ã‚¢
  - æ¨å¥¨åº¦ï¼ˆâ—â—‹â–²â–³Ã—ï¼‰

---

## ğŸ“Š å®Ÿè¡Œãƒ•ãƒ­ãƒ¼ï¼ˆå…¨ä½“åƒï¼‰

### Step 1: ãƒ‡ãƒ¼ã‚¿æº–å‚™
```bash
# Phase 2 ã®ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºã‚¹ã‚¯ãƒªãƒ—ãƒˆã§å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
python extract_training_data_v2.py --keibajo 44 --start-date 2023 --end-date 2024 --output ooi_2023-2024_v3.csv
```

### Step 2: äºŒå€¤åˆ†é¡ãƒ¢ãƒ‡ãƒ«ï¼ˆPhase 3 ã§å®Ÿæ–½æ¸ˆã¿ï¼‰
```bash
# 3ç€ä»¥å†…äºˆæ¸¬ãƒ¢ãƒ‡ãƒ«ã‚’å­¦ç¿’
python train_development.py ooi_2023-2024_v3.csv
```

### Step 3: ãƒ©ãƒ³ã‚­ãƒ³ã‚°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«
```bash
# race_id ã‚’è¿½åŠ ã—ãŸãƒ‡ãƒ¼ã‚¿ã§å­¦ç¿’
# æ³¨æ„: ãƒ‡ãƒ¼ã‚¿ã« race_id ã‚«ãƒ©ãƒ ãŒå¿…è¦
python train_ranking_model.py ooi_2023-2024_v3_with_race_id.csv
```

### Step 4: å›å¸°åˆ†æãƒ¢ãƒ‡ãƒ«
```bash
# target ã‚’èµ°ç ´ã‚¿ã‚¤ãƒ ã«å¤‰æ›´ã—ãŸãƒ‡ãƒ¼ã‚¿ã§å­¦ç¿’
python train_regression_model.py ooi_2023-2024_v3_time.csv
```

### Step 5: ã‚¢ãƒ³ã‚µãƒ³ãƒ–ãƒ«äºˆæ¸¬
```bash
# 3ã¤ã®ãƒ¢ãƒ‡ãƒ«ã§äºˆæ¸¬ã‚’çµ±åˆ
python ensemble_model.py prediction_data.csv \
    ooi_2023-2024_v3_model.txt \
    ooi_2023-2024_v3_ranking_model.txt \
    ooi_2023-2024_v3_regression_model.txt \
    --output ensemble_results.csv
```

---

## âš ï¸ é‡è¦ãªæ³¨æ„äº‹é …

### ãƒ‡ãƒ¼ã‚¿æº–å‚™ã®æ³¨æ„ç‚¹

#### 1. ãƒ©ãƒ³ã‚­ãƒ³ã‚°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ç”¨ãƒ‡ãƒ¼ã‚¿
```sql
-- race_id ã®è¿½åŠ ãŒå¿…è¦
SELECT 
    CONCAT(kaisai_nen, kaisai_tsukihi, keibajo_code, race_bango) AS race_id,
    CASE WHEN chakujun <= 3 THEN 1 ELSE 0 END AS target,  -- ç€é †ãã®ã‚‚ã®ã§ã‚‚OK
    ...
FROM nvd_ra r
JOIN nvd_se s ON ...
```

#### 2. å›å¸°åˆ†æãƒ¢ãƒ‡ãƒ«ç”¨ãƒ‡ãƒ¼ã‚¿
```sql
-- target ã‚’èµ°ç ´ã‚¿ã‚¤ãƒ ï¼ˆç§’ï¼‰ã«å¤‰æ›´
SELECT 
    time / 10.0 AS target,  -- ã‚¿ã‚¤ãƒ ï¼ˆ1/10ç§’å˜ä½ï¼‰ã‚’ç§’ã«å¤‰æ›
    ...
FROM nvd_ra r
JOIN nvd_se s ON ...
```

### ãƒ¢ãƒ‡ãƒ«å­¦ç¿’æ™‚ã®æ³¨æ„ç‚¹

#### Boruta ã«ã¤ã„ã¦
- ãƒ©ãƒ³ã‚­ãƒ³ã‚°å­¦ç¿’ã§ã¯ Boruta ã‚’ä½¿ç”¨ã—ãªã„
- äºŒå€¤åˆ†é¡ã§é¸å®šã—ãŸç‰¹å¾´é‡ãƒªã‚¹ãƒˆã‚’ä½¿ç”¨ã™ã‚‹
- `--feature-list` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ç‰¹å¾´é‡ã‚’æŒ‡å®š

#### ãƒã‚¤ãƒ‘ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
- Optunaã«ã‚ˆã‚‹è‡ªå‹•æœ€é©åŒ–ã‚’å®Ÿè¡Œ
- å„ãƒ¢ãƒ‡ãƒ«ã§æœ€é©ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒç•°ãªã‚‹
- `num_boost_round=1000`, `early_stopping(50)` ã§éå­¦ç¿’ã‚’é˜²æ­¢

---

## ğŸ“ˆ æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

### å„ãƒ¢ãƒ‡ãƒ«ã®ç‰¹å¾´

| ãƒ¢ãƒ‡ãƒ« | å¾—æ„ãªäºˆæ¸¬ | æœŸå¾…åŠ¹æœ |
|--------|-----------|----------|
| äºŒå€¤åˆ†é¡ | 3ç€ä»¥å†…ã‹å¦ã‹ | å …å®Ÿãªé¦¬ã‚’é¸å®š |
| ãƒ©ãƒ³ã‚­ãƒ³ã‚° | ç›¸å¯¾çš„ãªå¼·ã• | é †ä½ã®åºåˆ—ã‚’äºˆæ¸¬ |
| å›å¸° | èµ°ç ´ã‚¿ã‚¤ãƒ  | èƒ½åŠ›å€¤ã®æ•°å€¤åŒ–ã€ç©´é¦¬ç™ºè¦‹ |

### ã‚¢ãƒ³ã‚µãƒ³ãƒ–ãƒ«ã®å¼·ã¿
1. **å¤šè§’çš„ãªè©•ä¾¡**: 3ã¤ã®ç•°ãªã‚‹è¦–ç‚¹ã‹ã‚‰äºˆæ¸¬
2. **ç²¾åº¦å‘ä¸Š**: å„ãƒ¢ãƒ‡ãƒ«ã®å¼±ç‚¹ã‚’è£œå®Œ
3. **æŸ”è»Ÿãªèª¿æ•´**: é‡ã¿ã‚’èª¿æ•´ã—ã¦æˆ¦ç•¥ã‚’å¤‰æ›´å¯èƒ½

---

## ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### Q1: ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ¢ãƒ‡ãƒ«ã§ "race_id ã‚«ãƒ©ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" ã‚¨ãƒ©ãƒ¼
**A**: ãƒ‡ãƒ¼ã‚¿ã« race_id ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚  
```python
df['race_id'] = df['kaisai_nen'].astype(str) + df['kaisai_tsukihi'].astype(str) + df['keibajo_code'].astype(str) + df['race_bango'].astype(str)
```

### Q2: å›å¸°ãƒ¢ãƒ‡ãƒ«ã® RMSE ãŒå¤§ãã„
**A**: ç›®çš„å¤‰æ•°ã®ã‚¹ã‚±ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚  
- ã‚¿ã‚¤ãƒ ã‚’ç§’å˜ä½ã«å¤‰æ›ã™ã‚‹
- ã¾ãŸã¯å¯¾æ•°å¤‰æ›ã‚’æ¤œè¨

### Q3: ã‚¢ãƒ³ã‚µãƒ³ãƒ–ãƒ«ã§ "ç‰¹å¾´é‡ãŒå­˜åœ¨ã—ã¾ã›ã‚“" ã‚¨ãƒ©ãƒ¼
**A**: å„ãƒ¢ãƒ‡ãƒ«ã§ä½¿ç”¨ã—ãŸç‰¹å¾´é‡ãŒäºˆæ¸¬ãƒ‡ãƒ¼ã‚¿ã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚

---

## ğŸ“š å‚è€ƒè³‡æ–™

- [Phase 1 å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ](phase1_completion_report.md)
- [Phase 2 å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ](phase2_completion_report.md)
- [Phase 3 å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ](phase3_completion_report.md)
- [roadmap.md](../docs/roadmap.md)
- [prompts.md](../docs/prompts.md)

---

**æœ€çµ‚æ›´æ–°**: 2026-02-04  
**Phase**: Phase 4 - ãƒ¢ãƒ‡ãƒ«æ´¾ç”Ÿã¨ã‚¢ãƒ³ã‚µãƒ³ãƒ–ãƒ«çµ±åˆ
