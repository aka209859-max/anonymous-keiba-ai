# 🚨 重要な訂正：過去走データの正しい理解

## ⚠️ **申し訳ございませんでした**

前回の説明で**重大な誤り**がありました。訂正いたします。

---

## 🔄 **誤解の修正**

### ❌ 誤った説明（前回）

```
「kakutei_chakujun（着順）は除外」
「soha_time（走破タイム）は除外」
「kohan_3f（後半3F）は除外」
「corner_1～4（コーナー順位）は除外」
```

### ✅ 正しい理解（訂正後）

```
「**当該レース**の kakutei_chakujun は除外（目的変数）」
「**過去走**の kakutei_chakujun は使用可能（特徴量）」

「**当該レース**の soha_time は除外」
「**過去走**の soha_time は使用可能（特徴量）」
```

---

## 📊 **具体例で理解する**

### ケース：2026/02/04 姫路12R を予測

**予測対象馬：ウマA**

```
┌─────────────────────────────────────────────────┐
│ 2026/01/15  │ 2026/01/28  │ 2026/02/04 姫路12R │
│   3走前     │    前走     │    ← 予測対象     │
├─────────────────────────────────────────────────┤
│ 着順: 5着   │ 着順: 2着   │ 着順: ???        │
│ タイム:1:32 │ タイム:1:30 │ タイム: ???      │
│ 馬体重:480kg│ 馬体重:485kg│ 馬体重: ???      │
│ 人気: 8番人気│ 人気: 3番人気│ 人気: ???       │
└─────────────────────────────────────────────────┘
    ✅ 使用可      ✅ 使用可      ❌ 除外
   （既に確定）   （既に確定）   （未確定）
```

**重要なポイント:**
- 前走（2026/01/28）の着順・タイム・馬体重は**既に確定済み**なので使用可能
- 当該レース（2026/02/04）の着順・タイム・馬体重は**未確定**なので除外

---

## 📋 **正しい除外・使用リスト**

### ❌ 除外すべき項目（**当該レース**の情報のみ）

| カラム | 理由 | 備考 |
|--------|------|------|
| `kakutei_chakujun` | 予測対象（目的変数） | **当該レース**の着順 |
| `soha_time` | レース後に判明 | **当該レース**の走破タイム |
| `kohan_3f` | レース後に判明 | **当該レース**の後半3F |
| `corner_1, corner_2, corner_3, corner_4` | レース後に判明 | **当該レース**のコーナー順位 |
| `time_sa` | レース後に判明 | **当該レース**のタイム差 |
| `bataiju` | 当日計量で判明 | **当該レース当日**の馬体重 |
| `zougen` | 当日計量で判明 | **当該レース当日**の馬体重増減 |
| `tansho_odds` | 当日変動 | **当該レース当日**の単勝オッズ |
| `tansho_ninkijun` | 当日変動 | **当該レース当日**の人気順位 |

### ✅ 使用可能な項目（**過去走**の結果情報）

#### nvd_se テーブル（前走データ）

| カラム | データ種別 | 理由 |
|--------|------------|------|
| `zensou_kakutei_chakujun` | **前走**着順 | 既に確定済み |
| `zensou_soha_time` | **前走**走破タイム | 既に確定済み |
| `zensou_kohan_3f` | **前走**後半3F | 既に確定済み |
| `zensou_corner_1～4` | **前走**コーナー順位 | 既に確定済み |
| `zensou_bataiju` | **前走**馬体重 | 既に確定済み |
| `zensou_kyori` | **前走**距離 | 既に確定済み |
| `zensou_keibajo_code` | **前走**競馬場 | 既に確定済み |
| `zensou_track_code` | **前走**トラック | 既に確定済み |
| `zensou_babajotai_code` | **前走**馬場状態 | 既に確定済み |
| `zensou_tenko_code` | **前走**天候 | 既に確定済み |

#### nvd_um テーブル（2走前〜5走前のデータ）

| カラム | データ種別 | 理由 |
|--------|------------|------|
| `nisouzen_kakujun` | **2走前**着順 | 既に確定済み |
| `nisouzen_kyori` | **2走前**距離 | 既に確定済み |
| `nisouzen_baba_jotai` | **2走前**馬場状態 | 既に確定済み |
| `sansouzen_kakujun` | **3走前**着順 | 既に確定済み |
| `yonsouzen_kakujun` | **4走前**着順 | 既に確定済み |
| `gosouzen_kakujun` | **5走前**着順 | 既に確定済み |

### ⚠️ 除外推奨（使用は可能だが方針的に除外）

| カラム | データ種別 | 理由 |
|--------|------------|------|
| `zensou_tansho_odds` | **前走**単勝オッズ | ロードマップの方針「当日オッズ不使用の純粋AI」に基づく |
| `zensou_tansho_ninkijun` | **前走**人気順 | 同上 |

---

## 🗂️ **PC-KEIBA のテーブル構造**

### nvd_se（出馬表テーブル）

```sql
-- nvd_se テーブルには前走データが既に格納されている
SELECT 
  -- 馬の基本情報
  ketto_toroku_bango,
  umaban,
  
  -- ❌ 除外：当該レースの情報（予測対象）
  kakutei_chakujun,    -- 当該レースの着順（目的変数）
  soha_time,           -- 当該レースのタイム
  kohan_3f,            -- 当該レースの後半3F
  bataiju,             -- 当日馬体重（未確定）
  tansho_odds,         -- 当日オッズ（未確定）
  tansho_ninkijun,     -- 当日人気（未確定）
  
  -- ✅ 使用可：前走（1走前）の結果
  zensou_bataiju,           -- 前走馬体重
  zensou_kyori,             -- 前走距離
  zensou_keibajo_code,      -- 前走競馬場コード
  zensou_track_code,        -- 前走トラックコード
  -- ⚠️ PC-KEIBAのカラム名を確認する必要がある項目
  zensou_kakutei_chakujun,  -- 前走着順（カラム名要確認）
  zensou_soha_time,         -- 前走走破タイム（カラム名要確認）
  zensou_kohan_3f,          -- 前走後半3F（カラム名要確認）
  
FROM nvd_se;
```

### nvd_um（馬マスタ）

```sql
-- nvd_um には 2走前〜5走前のデータが格納されている
SELECT 
  ketto_toroku_bango,
  
  -- ✅ 使用可：2走前の結果
  nisouzen_kakujun AS prev2_rank,        -- 2走前着順
  nisouzen_kyori AS prev2_distance,      -- 2走前距離
  nisouzen_baba_jotai AS prev2_track,    -- 2走前馬場状態
  
  -- ✅ 使用可：3走前の結果
  sansouzen_kakujun AS prev3_rank,       -- 3走前着順
  
  -- ✅ 使用可：4走前の結果
  yonsouzen_kakujun AS prev4_rank,       -- 4走前着順
  
  -- ✅ 使用可：5走前の結果
  gosouzen_kakujun AS prev5_rank         -- 5走前着順
  
FROM nvd_um;
```

---

## 🎯 **まとめ図**

```
┌─────────────────────────────────────────────────────────┐
│                 時系列の整理                              │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  5走前    4走前    3走前    2走前    前走    当該レース │
│    ↓       ↓       ↓       ↓       ↓         ↓      │
│   着順5    着順3    着順8    着順2    着順1     着順???  │
│    ✅      ✅      ✅      ✅      ✅        ❌      │
│  使用可   使用可   使用可   使用可   使用可    除外     │
│ (nvd_um) (nvd_um) (nvd_um) (nvd_um) (nvd_se)  (目的変数)│
│                                                         │
│  ← 過去（既に確定済み）        予測対象（未確定） →   │
└─────────────────────────────────────────────────────────┘
```

---

## 📝 **次のステップ**

### 1. PC-KEIBAの実際のカラム名を確認

ローカル環境で以下のスクリプトを実行してください：

```cmd
python check_past_race_columns.py
```

このスクリプトは：
- nvd_se テーブルの前走関連カラムを確認
- nvd_um テーブルの過去走関連カラムを確認
- サンプルデータを表示

### 2. カラム名確認後、extract_training_data.py を修正

実際のカラム名が判明したら、SQLクエリに過去走データを追加します。

### 3. データを再抽出

```cmd
python extract_training_data.py --keibajo 44 --start-date 2023 --end-date 2024 --output ooi_2023-2024_v3.csv
```

**期待される結果:**
- **使用可能な特徴量: 30-50個**（前回の18個から大幅に増加）
  - 現在の18個 + 前走データ約10-15個 + 過去走データ約5-10個

### 4. 学習を実行

```cmd
python train_development.py ooi_2023-2024_v3.csv
```

**期待される精度向上:**
- 現在（過去走データなし）: AUC 0.60-0.75
- 修正後（過去走データあり）: **AUC 0.70-0.85**

---

## ✅ **理解確認**

以下の文を読んで「理解しました」と答えてください：

```
「当該レースの結果情報（着順・タイム・馬体重・オッズ）は除外するが、
 過去走（前走・2走前〜5走前）の結果情報は全て使用可能な特徴量である。
 PC-KEIBAのnvd_seテーブルには前走データが、nvd_umテーブルには2走前〜5走前の
 データが格納されており、これらを活用してモデルを学習する。」
```

---

## 🙏 **お詫び**

前回の説明で過去走データを除外すると誤って説明してしまい、申し訳ございませんでした。

**正しくは:**
- ❌ 除外: **当該レース**の結果データのみ
- ✅ 使用可能: **過去走**の結果データ全て

この理解で、Phase 2の過去走データ統合を進めます。

---

## 📞 **今すぐやること**

```cmd
# Step 1: 最新コードを取得
git pull origin genspark_ai_developer

# Step 2: 過去走カラム名を確認
python check_past_race_columns.py

# Step 3: 結果を報告
```

カラム名が判明したら、過去走データを統合したSQLを実装します！
