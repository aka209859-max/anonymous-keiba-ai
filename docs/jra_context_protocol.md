# JRA版AI予想システム - コンテキスト維持プロトコル

このドキュメントは、JRA版開発セッションでのコンテキスト喪失を防ぐための運用ルールです。

---

## 📋 セッション開始時の必須チェックリスト

### 必読ドキュメント（優先度順）

- [ ] **JRA_NEW_SESSION_QUICKSTART.md** を読んだか（5分で全体像把握）
- [ ] **JRA_VERSION_COMPLETE_REFERENCE.md** を読んだか（完全なコード例）
- [ ] **JRA_VERSION_INSTRUCTIONS.md** を読んだか（実装手順詳細）
- [ ] **このファイル（context_protocol.md）** を読んだか
- [ ] 前回のセッションログ（もしあれば）を確認したか

### 初回セッション専用チェック

- [ ] **JRA-VAN + JRDB ハイブリッド戦略** を理解したか
- [ ] データソースの分担（JRA-VAN: 基本情報、JRDB: 独自指数）を理解したか
- [ ] 目標精度（AUC 0.85以上、回収率120%以上）を確認したか
- [ ] 10競馬場（札幌、函館、福島、新潟、東京、中山、中京、京都、阪神、小倉）を確認したか

---

## 🎯 プロジェクト固有の制約事項（絶対に忘れないこと）

### データソース戦略

```
[JRA-VAN Data Lab] 公式データ
├─ 基本情報（馬名、騎手、調教師、枠番、斤量）
├─ 過去成績（着順、走破タイム）
├─ 馬場状態、天候
└─ オッズ情報（リアルタイム）

[JRDB] 独自指数
├─ IDM（総合指数） ★ 最重要
├─ タイム指数、ペース指数
├─ 血統評価、コース適性
└─ 展開予想（脚質分析）

【ハイブリッド効果】
AUC: 0.73 → 0.85以上
回収率: 85% → 120%以上
```

### 技術的制約

1. **データ取得は二本立て必須**
   - JRA-VANのみ ❌
   - JRDBのみ ❌
   - **ハイブリッド（両方） ✅**

2. **特徴量は70個以上**
   - JRA-VAN基本特徴量: 50個
   - JRDB独自指数: 20個
   - 合計: 70個以上

3. **芝・ダート対応必須**
   - 地方競馬（ダート主体）とは異なる
   - `track_type` カラムで区別
   - 芝/ダート別の特徴量を追加

4. **WIN5対応必須**
   - Phase 6 で実装
   - 指定5レースのTOP3組み合わせ（3^5 = 243点）

---

## ⏱️ 20ターンごとの確認事項

### 現在のタスク確認

1. **現在のフェーズ**: Phase X を実施中
2. **実装中の機能**: [具体的な機能名]
3. **進捗率**: X%

### 決定事項リスト

- ✅ [決定事項1]
- ✅ [決定事項2]
- ✅ [決定事項3]

### 未決事項リスト

- ❓ [未決事項1]
- ❓ [未決事項2]

### コード実装状況

```python
# 実装済みスクリプト
scripts/phase0_data_acquisition/extract_race_data_jra.py  # ✅
scripts/phase1_feature_engineering/prepare_features_jra.py  # 🔄 実装中
scripts/phase3_binary/predict_phase3_inference_jra.py  # ❌ 未着手
```

---

## 📝 セッション終了時のプロトコル

### 1. 作業内容を記録

```bash
# session_log.md に追記
echo "## セッション $(date +%Y-%m-%d)

### 完了タスク
- Phase X の Y 実装完了

### 決定事項
- [決定事項1]
- [決定事項2]

### 次回タスク
- Phase X+1 の実装開始
" >> docs/session_log.md
```

### 2. Gitコミット

```bash
# 変更をコミット
git add .
git commit -m "feat(phaseX): [実装内容の簡潔な説明]

- [変更点1]
- [変更点2]
- [変更点3]"

git push origin main
```

### 3. 次回のタスクを明示

```markdown
## 次回セッション開始時のタスク

1. Phase X+1 の実装開始
2. [具体的なタスク1]
3. [具体的なタスク2]

### 必要なファイル
- JRA_VERSION_COMPLETE_REFERENCE.md（Phase X+1 のセクション）
- docs/context_protocol.md（このファイル）
```

---

## 🚨 コンテキストの腐敗（Context Rot）の兆候

以下の症状が出たら、**即座にセッションをリセット**すること:

### 重大な兆候

- ❌ **JRA-VAN + JRDB ハイブリッド戦略を忘れている**
  - 例: "JRA-VANだけで十分では？"
  - 例: "JRDBは使わない方針にしましょう"
  
- ❌ **データソースの分担を忘れている**
  - 例: JRDBから基本情報を取得しようとする
  - 例: JRA-VANから独自指数を取得しようとする

- ❌ **目標精度を忘れている**
  - 例: "AUC 0.75で十分では？"（目標は0.85以上）
  - 例: "回収率100%で良いですね"（目標は120%以上）

- ❌ **10競馬場を忘れている**
  - 例: 地方競馬場（門別、船橋など）を含めようとする
  - 例: 競馬場数を14場と言及する

### 一般的な兆候

- ❌ 以前の決定事項を忘れている
- ❌ 制約条件を無視し始める
- ❌ 本来の目的（JRA版AI予想システム構築）から逸脱する
- ❌ 同じ質問を繰り返す
- ❌ Phase 0-10 の実装順序を無視する

---

## 🔧 緊急時の復旧手順

### コンテキスト喪失を検知した場合

1. **現在のセッションを終了**
   - 作業内容を `docs/session_log.md` に記録
   - 未コミットの変更をコミット

2. **新しいセッションを開始**
   - 以下の3ファイルを添付:
     - `JRA_NEW_SESSION_QUICKSTART.md`
     - `JRA_VERSION_COMPLETE_REFERENCE.md`
     - `JRA_VERSION_INSTRUCTIONS.md`

3. **コンテキスト再読込**
   - 新規セッションテンプレートを使用
   - このファイル（`context_protocol.md`）を再読込
   - `docs/session_log.md` で前回の作業内容を確認

4. **作業再開**
   - 前回の続きから実装を再開

---

## 📚 重要なリファレンス

### データソース関連

- **JRA-VAN Data Lab**: 公式データ（基本情報、オッズ）
- **JRDB**: 独自指数（IDM、タイム指数、ペース指数など20指数）
- **ハイブリッド効果**: AUC +16%、回収率 +41%

### 技術スタック

- Python 3.14
- LightGBM（二値分類、Ranker、Regressor）
- Optuna（自動最適化）
- Kelly基準（資金管理）

### 実装フェーズ

```
Phase 0: JRA-VAN + JRDB ハイブリッドデータ取得
Phase 1: 70特徴量エンジニアリング
Phase 2: 学習データ準備（2020-2025年）
Phase 3: 二値分類（AUC 0.85以上目標）
Phase 4-1: ランキング予測
Phase 4-2: 回帰予測
Phase 5: アンサンブル統合（30/50/20%）
Phase 6: WIN5対応買い目生成
Phase 7: Greedy Boruta特徴量選択
Phase 8: Optuna自動最適化
Phase 9: Kelly基準ベッティングエンジン
Phase 10: バックテスト・ROI検証
```

---

## 🎯 セッション品質チェック

### 毎回確認すべき質問

1. **データソース戦略を理解しているか？**
   - JRA-VANとJRDBの役割分担を説明できるか？

2. **目標精度を覚えているか？**
   - AUC: 0.85以上、回収率: 120%以上

3. **実装フェーズの順序を守っているか？**
   - Phase 0 → Phase 1 → ... → Phase 10

4. **JRA固有の要件を理解しているか？**
   - 芝・ダート対応
   - WIN5対応
   - 10競馬場対応

5. **コードの実装例を参照しているか？**
   - `JRA_VERSION_COMPLETE_REFERENCE.md` を活用しているか？

---

## 📖 関連ドキュメント

- **JRA_NEW_SESSION_QUICKSTART.md** - クイックスタート（5分）
- **JRA_VERSION_COMPLETE_REFERENCE.md** - 完全リファレンス（47 KB）
- **JRA_VERSION_INSTRUCTIONS.md** - 実装指示書（23 KB）
- **docs/session_log.md** - セッション履歴
- **README.md** - プロジェクト概要

---

**最終更新**: 2026年02月14日  
**バージョン**: 1.0  
**ステータス**: ✅ 完成

---

**このファイルを忘れずに新規セッションで読み込んでください！**
