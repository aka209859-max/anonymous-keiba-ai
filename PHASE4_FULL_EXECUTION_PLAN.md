# Phase 4 å®Œå…¨å®Ÿè¡Œè¨ˆç”»æ›¸

**ä½œæˆæ—¥**: 2026-02-04  
**ç›®çš„**: æœ€å¼·ã®åœ°æ–¹ç«¶é¦¬äºˆæƒ³ã‚·ã‚¹ãƒ†ãƒ ã®æ§‹ç¯‰ - Phase 4ï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°å­¦ç¿’ãƒ»å›å¸°åˆ†æãƒ»ã‚¢ãƒ³ã‚µãƒ³ãƒ–ãƒ«çµ±åˆï¼‰ã®å®Œå…¨å®Ÿè¡Œ

---

## ğŸ“Š ç¾çŠ¶ç¢ºèª

### âœ… å®Œäº†æ¸ˆã¿
- Phase 1-3: äºŒå€¤åˆ†é¡ãƒ¢ãƒ‡ãƒ«ã®å­¦ç¿’ï¼ˆ10ç«¶é¦¬å ´ï¼‰
- Phase 4.5: 2026å¹´1æœˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œï¼ˆçš„ä¸­ç‡æ¤œè¨¼ï¼‰
- ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè£…: `train_ranking_model.py`, `train_regression_model.py`, `ensemble_model.py`

### âš ï¸ æœªå®Ÿæ–½
- ãƒ©ãƒ³ã‚­ãƒ³ã‚°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã®å­¦ç¿’ï¼ˆ10ç«¶é¦¬å ´ï¼‰
- å›å¸°åˆ†æãƒ¢ãƒ‡ãƒ«ã®å­¦ç¿’ï¼ˆ10ç«¶é¦¬å ´ï¼‰
- ã‚¢ãƒ³ã‚µãƒ³ãƒ–ãƒ«äºˆæ¸¬ã®å®Ÿè¡Œï¼ˆ3ãƒ¢ãƒ‡ãƒ«çµ±åˆï¼‰

---

## ğŸ¯ Phase 4 å®Œå…¨å®Ÿè¡Œã®ç›®æ¨™

### æœ€çµ‚æˆæœç‰©
1. **ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ¢ãƒ‡ãƒ«**: å„ç«¶é¦¬å ´ã§ç›¸å¯¾é †ä½ã‚’å­¦ç¿’ï¼ˆ10ç«¶é¦¬å ´ Ã— 1ãƒ¢ãƒ‡ãƒ« = 10ãƒ¢ãƒ‡ãƒ«ï¼‰
2. **å›å¸°ãƒ¢ãƒ‡ãƒ«**: å„ç«¶é¦¬å ´ã§èµ°ç ´ã‚¿ã‚¤ãƒ ã‚’äºˆæ¸¬ï¼ˆ10ç«¶é¦¬å ´ Ã— 1ãƒ¢ãƒ‡ãƒ« = 10ãƒ¢ãƒ‡ãƒ«ï¼‰
3. **ã‚¢ãƒ³ã‚µãƒ³ãƒ–ãƒ«äºˆæ¸¬**: 2026å¹´1æœˆãƒ‡ãƒ¼ã‚¿ã§3ãƒ¢ãƒ‡ãƒ«çµ±åˆäºˆæ¸¬ã‚’å®Ÿè¡Œ
4. **è©•ä¾¡ãƒ¬ãƒãƒ¼ãƒˆ**: çš„ä¸­ç‡ãƒ»æ¨å¥¨åº¦åˆ¥åˆ†æï¼ˆâ—æœ¬å‘½/â—‹å¯¾æŠ—/â–²å˜ç©´/â–³é€£ä¸‹/Ã—è©•ä¾¡ä½/æ¶ˆå»ï¼‰

### æœŸå¾…åŠ¹æœ
- **å¤šè§’çš„äºˆæ¸¬**: äºŒå€¤åˆ†é¡ï¼ˆç¢ºç‡ï¼‰+ ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆé †ä½ï¼‰+ å›å¸°ï¼ˆã‚¿ã‚¤ãƒ ï¼‰ã®3ã¤ã®è¦–ç‚¹
- **ç²¾åº¦å‘ä¸Š**: å„ãƒ¢ãƒ‡ãƒ«ã®å¼·ã¿ã‚’çµ„ã¿åˆã‚ã›ã¦å¼±ç‚¹ã‚’è£œå®Œ
- **å®Ÿæˆ¦æŠ•å…¥å¯èƒ½**: è²·ã„ç›®ã®å„ªå…ˆé †ä½ã‚’æ˜ç¢ºåŒ–ï¼ˆâ—â—‹â–²â–³Ã—ï¼‰

---

## ğŸ“‹ å®Ÿè¡Œã‚¹ãƒ†ãƒƒãƒ—ï¼ˆå…¨ä½“ãƒ•ãƒ­ãƒ¼ï¼‰

### Step 0: å‰æç¢ºèª
- Windowsç’°å¢ƒ: `E:\anonymous-keiba-ai`
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹: PostgreSQL (localhost:5432, database: pckeiba)
- æ—¢å­˜ãƒ¢ãƒ‡ãƒ«: äºŒå€¤åˆ†é¡ãƒ¢ãƒ‡ãƒ«ï¼ˆPhase 3ã§å­¦ç¿’æ¸ˆã¿ï¼‰
  - `ooi_2023-2024_v3_model.txt` (å¤§äº• 32ç‰¹å¾´é‡)
  - `funabashi_2020-2025_v3_model.txt` (èˆ¹æ©‹ 34ç‰¹å¾´é‡)
  - ä»–8ç«¶é¦¬å ´ã®ãƒ¢ãƒ‡ãƒ«

### Step 1: ãƒ‡ãƒ¼ã‚¿æº–å‚™ï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°å­¦ç¿’ç”¨ï¼‰
**ç›®çš„**: `race_id` ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ä½œæˆ

#### 1-1. æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ä¿®æ­£ï¼ˆæ¨å¥¨æ–¹æ³•ï¼‰
æ—¢å­˜ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã« `race_id` ã‚’è¿½åŠ ã™ã‚‹ï¼š

```python
# add_race_id_to_csv.py (æ–°è¦ä½œæˆ)
import pandas as pd
import sys

csv_file = sys.argv[1]  # ä¾‹: ooi_2023-2024_v3.csv
df = pd.read_csv(csv_file, encoding='shift-jis')

# race_idã‚’ä½œæˆ
df['race_id'] = (
    df['kaisai_nen'].astype(str) + 
    df['kaisai_tsukihi'].astype(str).str.zfill(4) + 
    df['keibajo_code'].astype(str) + 
    df['race_bango'].astype(str).str.zfill(2)
)

# ä¿å­˜
output_file = csv_file.replace('.csv', '_with_race_id.csv')
df.to_csv(output_file, index=False, encoding='shift-jis')
print(f"âœ“ ä¿å­˜å®Œäº†: {output_file}")
print(f"  - ãƒ¬ãƒ¼ã‚¹æ•°: {df['race_id'].nunique():,}ä»¶")
print(f"  - ãƒ‡ãƒ¼ã‚¿ä»¶æ•°: {len(df):,}ä»¶")
```

**å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰**:
```bash
cd E:\anonymous-keiba-ai
python add_race_id_to_csv.py ooi_2023-2024_v3.csv
python add_race_id_to_csv.py funabashi_2020-2025_v3.csv
# ... ä»–8ç«¶é¦¬å ´ã‚‚åŒæ§˜
```

#### 1-2. SQLã‹ã‚‰å†æŠ½å‡ºï¼ˆä»£æ›¿æ–¹æ³•ï¼‰
`extract_training_data_v2.py` ã‚’ä¿®æ­£ã—ã¦ race_id ã‚’è¿½åŠ ï¼š

```python
# extract_training_data_v2.py ã®ä¿®æ­£ç®‡æ‰€
def create_query_with_past_races(...):
    query = f"""
    WITH target_race AS (
        SELECT 
            -- race_idã‚’è¿½åŠ 
            CONCAT(r.kaisai_nen, LPAD(r.kaisai_tsukihi::text, 4, '0'), r.keibajo_code, LPAD(r.race_bango::text, 2, '0')) AS race_id,
            
            -- æ—¢å­˜ã®ã‚«ãƒ©ãƒ 
            CASE WHEN s.kakutei_chakujun::int <= 3 THEN 1 ELSE 0 END AS target,
            r.kaisai_nen,
            ...
```

### Step 2: ãƒ‡ãƒ¼ã‚¿æº–å‚™ï¼ˆå›å¸°åˆ†æç”¨ï¼‰
**ç›®çš„**: `target` ã‚’èµ°ç ´ã‚¿ã‚¤ãƒ ï¼ˆç§’ï¼‰ã«å¤‰æ›´ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ä½œæˆ

#### 2-1. æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ä¿®æ­£ï¼ˆæ¨å¥¨æ–¹æ³•ï¼‰
æ—¢å­˜ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã® target ã‚’èµ°ç ´ã‚¿ã‚¤ãƒ ã«å¤‰æ›´ï¼š

```python
# convert_target_to_time.py (æ–°è¦ä½œæˆ)
import pandas as pd
import sys

csv_file = sys.argv[1]  # ä¾‹: ooi_2023-2024_v3.csv
df = pd.read_csv(csv_file, encoding='shift-jis')

# targetã‚’èµ°ç ´ã‚¿ã‚¤ãƒ ã«å¤‰æ›´ï¼ˆtime ã‚«ãƒ©ãƒ ãŒå­˜åœ¨ã™ã‚‹ã¨ä»®å®šï¼‰
if 'time' in df.columns:
    # timeã¯1/10ç§’å˜ä½ â†’ ç§’ã«å¤‰æ›
    df['target'] = df['time'] / 10.0
elif 'prev1_time' in df.columns:
    # å‰èµ°ã‚¿ã‚¤ãƒ ã‚’ä½¿ç”¨ï¼ˆå¿œæ€¥å‡¦ç½®ï¼‰
    df['target'] = df['prev1_time']
else:
    print("ã‚¨ãƒ©ãƒ¼: ã‚¿ã‚¤ãƒ ã‚«ãƒ©ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
    sys.exit(1)

# æ¬ æå€¤ã‚’é™¤å»
df = df[df['target'].notna()]
df = df[df['target'] > 0]

# ä¿å­˜
output_file = csv_file.replace('.csv', '_time.csv')
df.to_csv(output_file, index=False, encoding='shift-jis')
print(f"âœ“ ä¿å­˜å®Œäº†: {output_file}")
print(f"  - ãƒ‡ãƒ¼ã‚¿ä»¶æ•°: {len(df):,}ä»¶")
print(f"  - ã‚¿ã‚¤ãƒ ç¯„å›²: {df['target'].min():.2f}ç§’ ~ {df['target'].max():.2f}ç§’")
```

**å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰**:
```bash
cd E:\anonymous-keiba-ai
python convert_target_to_time.py ooi_2023-2024_v3.csv
python convert_target_to_time.py funabashi_2020-2025_v3.csv
# ... ä»–8ç«¶é¦¬å ´ã‚‚åŒæ§˜
```

#### 2-2. SQLã‹ã‚‰å†æŠ½å‡ºï¼ˆä»£æ›¿æ–¹æ³•ï¼‰
`extract_training_data_v2.py` ã‚’ä¿®æ­£ã—ã¦ time ã‚’ target ã«ï¼š

```python
# target ã‚’èµ°ç ´ã‚¿ã‚¤ãƒ ã«å¤‰æ›´
query = f"""
WITH target_race AS (
    SELECT 
        s.time / 10.0 AS target,  -- èµ°ç ´ã‚¿ã‚¤ãƒ ï¼ˆç§’ï¼‰
        r.kaisai_nen,
        ...
```

### Step 3: ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ¢ãƒ‡ãƒ«å­¦ç¿’ï¼ˆ10ç«¶é¦¬å ´ï¼‰
**å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰**:

```bash
cd E:\anonymous-keiba-ai

# å¤§äº•ï¼ˆã‚³ãƒ¼ãƒ‰: 44ï¼‰
python train_ranking_model.py ooi_2023-2024_v3_with_race_id.csv

# èˆ¹æ©‹ï¼ˆã‚³ãƒ¼ãƒ‰: 43ï¼‰
python train_ranking_model.py funabashi_2020-2025_v3_with_race_id.csv

# å·å´ï¼ˆã‚³ãƒ¼ãƒ‰: 45ï¼‰
python train_ranking_model.py kawasaki_2020-2025_v3_with_race_id.csv

# æµ¦å’Œï¼ˆã‚³ãƒ¼ãƒ‰: 42ï¼‰
python train_ranking_model.py urawa_2020-2025_v3_with_race_id.csv

# åå¤å±‹ï¼ˆã‚³ãƒ¼ãƒ‰: 48ï¼‰
python train_ranking_model.py nagoya_2022-2025_v3_with_race_id.csv

# åœ’ç”°ï¼ˆã‚³ãƒ¼ãƒ‰: 50ï¼‰
python train_ranking_model.py sonoda_2020-2025_v3_with_race_id.csv

# ç¬ æ¾ï¼ˆã‚³ãƒ¼ãƒ‰: 47ï¼‰
python train_ranking_model.py kasamatsu_2020-2025_v3_with_race_id.csv

# ä½è³€ï¼ˆã‚³ãƒ¼ãƒ‰: 55ï¼‰
python train_ranking_model.py saga_2020-2025_v3_with_race_id.csv

# é«˜çŸ¥ï¼ˆã‚³ãƒ¼ãƒ‰: 54ï¼‰
python train_ranking_model.py kochi_2020-2025_v3_with_race_id.csv

# å§«è·¯ï¼ˆã‚³ãƒ¼ãƒ‰: 51ï¼‰
python train_ranking_model.py himeji_2020-2025_v3_with_race_id.csv
```

**æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›ï¼ˆå„ç«¶é¦¬å ´ï¼‰**:
- `{venue}_ranking_model.txt`: ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ¢ãƒ‡ãƒ«
- `{venue}_ranking_model.png`: ç‰¹å¾´é‡é‡è¦åº¦ã‚°ãƒ©ãƒ•
- `{venue}_ranking_score.txt`: è©•ä¾¡æŒ‡æ¨™ï¼ˆNDCG@1, @3, @5, @10ï¼‰

### Step 4: å›å¸°ãƒ¢ãƒ‡ãƒ«å­¦ç¿’ï¼ˆ10ç«¶é¦¬å ´ï¼‰
**å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰**:

```bash
cd E:\anonymous-keiba-ai

# å¤§äº•ï¼ˆã‚³ãƒ¼ãƒ‰: 44ï¼‰
python train_regression_model.py ooi_2023-2024_v3_time.csv

# èˆ¹æ©‹ï¼ˆã‚³ãƒ¼ãƒ‰: 43ï¼‰
python train_regression_model.py funabashi_2020-2025_v3_time.csv

# ... ä»–8ç«¶é¦¬å ´ã‚‚åŒæ§˜
```

**æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›ï¼ˆå„ç«¶é¦¬å ´ï¼‰**:
- `{venue}_regression_model.txt`: å›å¸°ãƒ¢ãƒ‡ãƒ«
- `{venue}_regression_model.png`: ç‰¹å¾´é‡é‡è¦åº¦ã‚°ãƒ©ãƒ•
- `{venue}_regression_score.txt`: è©•ä¾¡æŒ‡æ¨™ï¼ˆRMSE, MAE, RÂ²ï¼‰

### Step 5: ã‚¢ãƒ³ã‚µãƒ³ãƒ–ãƒ«äºˆæ¸¬ï¼ˆ2026å¹´1æœˆãƒ‡ãƒ¼ã‚¿ï¼‰
**ç›®çš„**: 3ãƒ¢ãƒ‡ãƒ«çµ±åˆã§æœ€çµ‚äºˆæ¸¬ã‚’å®Ÿè¡Œ

#### 5-1. äºˆæ¸¬å¯¾è±¡ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™
2026å¹´1æœˆãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºï¼ˆæ—¢å­˜ã® `simulate_2026_venue_adaptive.py` ã‚’æ´»ç”¨ï¼‰ï¼š

```bash
# æ—¢å­˜ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
python simulate_2026_venue_adaptive.py
```

ã¾ãŸã¯ã€æ–°è¦ã«äºˆæ¸¬ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆï¼š

```python
# extract_2026_prediction_data.py (æ–°è¦ä½œæˆ)
# 2026å¹´1æœˆã®ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºï¼ˆtargetã¯ä¸è¦ï¼‰
```

#### 5-2. ã‚¢ãƒ³ã‚µãƒ³ãƒ–ãƒ«äºˆæ¸¬ã®å®Ÿè¡Œ

```bash
cd E:\anonymous-keiba-ai

# å¤§äº•ï¼ˆã‚³ãƒ¼ãƒ‰: 44ï¼‰
python ensemble_model.py prediction_data_ooi_2026_01.csv \
    ooi_2023-2024_v3_model.txt \
    ooi_2023-2024_v3_ranking_model.txt \
    ooi_2023-2024_v3_regression_model.txt \
    --output ensemble_ooi_2026_01.csv

# èˆ¹æ©‹ï¼ˆã‚³ãƒ¼ãƒ‰: 43ï¼‰
python ensemble_model.py prediction_data_funabashi_2026_01.csv \
    funabashi_2020-2025_v3_model.txt \
    funabashi_2020-2025_v3_ranking_model.txt \
    funabashi_2020-2025_v3_regression_model.txt \
    --output ensemble_funabashi_2026_01.csv

# ... ä»–8ç«¶é¦¬å ´ã‚‚åŒæ§˜
```

**æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›ï¼ˆå„ç«¶é¦¬å ´ï¼‰**:
- `ensemble_{venue}_2026_01.csv`: ã‚¢ãƒ³ã‚µãƒ³ãƒ–ãƒ«äºˆæ¸¬çµæœ
  - å„ãƒ¢ãƒ‡ãƒ«ã®äºˆæ¸¬å€¤ï¼ˆbinary_proba, ranking_score, regression_timeï¼‰
  - æ­£è¦åŒ–ã‚¹ã‚³ã‚¢ï¼ˆbinary_norm, ranking_norm, regression_normï¼‰
  - ç·åˆã‚¹ã‚³ã‚¢ï¼ˆensemble_scoreï¼‰
  - æ¨å¥¨åº¦ï¼ˆrecommendation: â—æœ¬å‘½/â—‹å¯¾æŠ—/â–²å˜ç©´/â–³é€£ä¸‹/Ã—è©•ä¾¡ä½/æ¶ˆå»ï¼‰

### Step 6: è©•ä¾¡ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
**ç›®çš„**: çš„ä¸­ç‡ãƒ»æ¨å¥¨åº¦åˆ¥åˆ†æ

#### 6-1. æ¨å¥¨åº¦åˆ¥ã®çš„ä¸­ç‡é›†è¨ˆ

```python
# analyze_ensemble_results.py (æ–°è¦ä½œæˆ)
import pandas as pd
import glob

# å…¨ç«¶é¦¬å ´ã®ã‚¢ãƒ³ã‚µãƒ³ãƒ–ãƒ«çµæœã‚’èª­ã¿è¾¼ã¿
ensemble_files = glob.glob('ensemble_*_2026_01.csv')

results = []
for file in ensemble_files:
    df = pd.read_csv(file, encoding='shift-jis')
    
    # æ¨å¥¨åº¦åˆ¥ã®é›†è¨ˆ
    summary = df.groupby('recommendation').agg({
        'kakutei_chakujun': [
            'count',
            lambda x: (x <= 3).sum()  # 3ç€ä»¥å†…ã®ä»¶æ•°
        ]
    })
    
    summary.columns = ['ä»¶æ•°', '3ç€ä»¥å†…ä»¶æ•°']
    summary['çš„ä¸­ç‡'] = (summary['3ç€ä»¥å†…ä»¶æ•°'] / summary['ä»¶æ•°'] * 100).round(2)
    
    results.append({
        'venue': file.replace('ensemble_', '').replace('_2026_01.csv', ''),
        'summary': summary
    })

# å…¨ä½“é›†è¨ˆ
print("=" * 80)
print("Phase 4 ã‚¢ãƒ³ã‚µãƒ³ãƒ–ãƒ«äºˆæ¸¬ - æ¨å¥¨åº¦åˆ¥çš„ä¸­ç‡")
print("=" * 80)

for result in results:
    print(f"\nã€{result['venue']}ã€‘")
    print(result['summary'].to_string())
```

#### 6-2. æœŸå¾…ã•ã‚Œã‚‹åˆ†æé …ç›®
1. **æ¨å¥¨åº¦åˆ¥çš„ä¸­ç‡**
   - â—æœ¬å‘½: XX% (æœŸå¾…: 50-60%)
   - â—‹å¯¾æŠ—: XX% (æœŸå¾…: 35-45%)
   - â–²å˜ç©´: XX% (æœŸå¾…: 25-35%)
   - â–³é€£ä¸‹: XX% (æœŸå¾…: 15-25%)
   - Ã—è©•ä¾¡ä½: XX% (æœŸå¾…: 5-15%)
   - æ¶ˆå»: XX% (æœŸå¾…: <5%)

2. **ãƒ¢ãƒ‡ãƒ«åˆ¥ã®å¯„ä¸åº¦åˆ†æ**
   - äºŒå€¤åˆ†é¡ãƒ¢ãƒ‡ãƒ«ã®å½±éŸ¿åº¦
   - ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ¢ãƒ‡ãƒ«ã®å½±éŸ¿åº¦
   - å›å¸°ãƒ¢ãƒ‡ãƒ«ã®å½±éŸ¿åº¦

3. **ç«¶é¦¬å ´åˆ¥ã®æœ€é©é‡ã¿**
   - å„ç«¶é¦¬å ´ã§æœ€é©ãªã‚¢ãƒ³ã‚µãƒ³ãƒ–ãƒ«é‡ã¿ã‚’æ¢ç´¢

---

## ğŸ”§ å®Ÿè£…ã‚µãƒãƒ¼ãƒˆãƒ„ãƒ¼ãƒ«

### Tool 1: `add_race_id_to_csv.py`
**ç›®çš„**: æ—¢å­˜CSVã« race_id ã‚«ãƒ©ãƒ ã‚’è¿½åŠ 

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
add_race_id_to_csv.py
æ—¢å­˜ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã« race_id ã‚«ãƒ©ãƒ ã‚’è¿½åŠ 
"""
import pandas as pd
import sys
import os

def main():
    if len(sys.argv) < 2:
        print("ä½¿ç”¨æ³•: python add_race_id_to_csv.py <csvãƒ•ã‚¡ã‚¤ãƒ«å>")
        sys.exit(1)
    
    csv_file = sys.argv[1]
    
    if not os.path.exists(csv_file):
        print(f"ã‚¨ãƒ©ãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ« '{csv_file}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
        sys.exit(1)
    
    print(f"å‡¦ç†ä¸­: {csv_file}")
    
    # ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    try:
        df = pd.read_csv(csv_file, encoding='shift-jis')
    except UnicodeDecodeError:
        df = pd.read_csv(csv_file, encoding='utf-8')
    
    print(f"  - èª­ã¿è¾¼ã¿å®Œäº†: {len(df):,}ä»¶")
    
    # race_idã‚’ä½œæˆ
    df['race_id'] = (
        df['kaisai_nen'].astype(str) + 
        df['kaisai_tsukihi'].astype(str).str.zfill(4) + 
        df['keibajo_code'].astype(str) + 
        df['race_bango'].astype(str).str.zfill(2)
    )
    
    print(f"  - race_idä½œæˆå®Œäº†: {df['race_id'].nunique():,}ãƒ¬ãƒ¼ã‚¹")
    
    # ä¿å­˜
    output_file = csv_file.replace('.csv', '_with_race_id.csv')
    df.to_csv(output_file, index=False, encoding='shift-jis')
    
    print(f"âœ“ ä¿å­˜å®Œäº†: {output_file}")
    print(f"  - ãƒ¬ãƒ¼ã‚¹æ•°: {df['race_id'].nunique():,}ä»¶")
    print(f"  - ãƒ‡ãƒ¼ã‚¿ä»¶æ•°: {len(df):,}ä»¶")

if __name__ == "__main__":
    main()
```

### Tool 2: `convert_target_to_time.py`
**ç›®çš„**: targetã‚’èµ°ç ´ã‚¿ã‚¤ãƒ ã«å¤‰æ›´

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
convert_target_to_time.py
CSVãƒ•ã‚¡ã‚¤ãƒ«ã®targetã‚«ãƒ©ãƒ ã‚’èµ°ç ´ã‚¿ã‚¤ãƒ ã«å¤‰æ›´
"""
import pandas as pd
import sys
import os

def main():
    if len(sys.argv) < 2:
        print("ä½¿ç”¨æ³•: python convert_target_to_time.py <csvãƒ•ã‚¡ã‚¤ãƒ«å>")
        sys.exit(1)
    
    csv_file = sys.argv[1]
    
    if not os.path.exists(csv_file):
        print(f"ã‚¨ãƒ©ãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ« '{csv_file}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
        sys.exit(1)
    
    print(f"å‡¦ç†ä¸­: {csv_file}")
    
    # ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    try:
        df = pd.read_csv(csv_file, encoding='shift-jis')
    except UnicodeDecodeError:
        df = pd.read_csv(csv_file, encoding='utf-8')
    
    print(f"  - èª­ã¿è¾¼ã¿å®Œäº†: {len(df):,}ä»¶")
    
    # timeã‚«ãƒ©ãƒ ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
    if 'time' in df.columns:
        # timeã¯1/10ç§’å˜ä½ â†’ ç§’ã«å¤‰æ›
        df['target'] = df['time'] / 10.0
        print("  - time ã‚«ãƒ©ãƒ ã‹ã‚‰ target ã‚’ä½œæˆ")
    elif 'prev1_time' in df.columns:
        # å‰èµ°ã‚¿ã‚¤ãƒ ã‚’ä½¿ç”¨ï¼ˆå¿œæ€¥å‡¦ç½®ï¼‰
        df['target'] = df['prev1_time']
        print("  - prev1_time ã‚«ãƒ©ãƒ ã‹ã‚‰ target ã‚’ä½œæˆï¼ˆå¿œæ€¥å‡¦ç½®ï¼‰")
    else:
        print("ã‚¨ãƒ©ãƒ¼: ã‚¿ã‚¤ãƒ ã‚«ãƒ©ãƒ ï¼ˆtime ã¾ãŸã¯ prev1_timeï¼‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
        print(f"åˆ©ç”¨å¯èƒ½ãªã‚«ãƒ©ãƒ : {df.columns.tolist()}")
        sys.exit(1)
    
    # æ¬ æå€¤ã‚’é™¤å»
    original_count = len(df)
    df = df[df['target'].notna()]
    df = df[df['target'] > 0]
    removed_count = original_count - len(df)
    
    if removed_count > 0:
        print(f"  - æ¬ æå€¤ãƒ»ç•°å¸¸å€¤ã‚’é™¤å»: {removed_count}ä»¶")
    
    # ä¿å­˜
    output_file = csv_file.replace('.csv', '_time.csv')
    df.to_csv(output_file, index=False, encoding='shift-jis')
    
    print(f"âœ“ ä¿å­˜å®Œäº†: {output_file}")
    print(f"  - ãƒ‡ãƒ¼ã‚¿ä»¶æ•°: {len(df):,}ä»¶")
    print(f"  - ã‚¿ã‚¤ãƒ ç¯„å›²: {df['target'].min():.2f}ç§’ ~ {df['target'].max():.2f}ç§’")
    print(f"  - ã‚¿ã‚¤ãƒ å¹³å‡: {df['target'].mean():.2f}ç§’")

if __name__ == "__main__":
    main()
```

### Tool 3: `run_phase4_training.py`
**ç›®çš„**: å…¨ç«¶é¦¬å ´ã®å­¦ç¿’ã‚’ä¸€æ‹¬å®Ÿè¡Œ

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
run_phase4_training.py
Phase 4 ã®å…¨ç«¶é¦¬å ´å­¦ç¿’ã‚’ä¸€æ‹¬å®Ÿè¡Œ
"""
import subprocess
import os
from datetime import datetime

VENUES = [
    {'code': '44', 'name': 'å¤§äº•', 'csv': 'ooi_2023-2024_v3.csv'},
    {'code': '43', 'name': 'èˆ¹æ©‹', 'csv': 'funabashi_2020-2025_v3.csv'},
    {'code': '45', 'name': 'å·å´', 'csv': 'kawasaki_2020-2025_v3.csv'},
    {'code': '42', 'name': 'æµ¦å’Œ', 'csv': 'urawa_2020-2025_v3.csv'},
    {'code': '48', 'name': 'åå¤å±‹', 'csv': 'nagoya_2022-2025_v3.csv'},
    {'code': '50', 'name': 'åœ’ç”°', 'csv': 'sonoda_2020-2025_v3.csv'},
    {'code': '47', 'name': 'ç¬ æ¾', 'csv': 'kasamatsu_2020-2025_v3.csv'},
    {'code': '55', 'name': 'ä½è³€', 'csv': 'saga_2020-2025_v3.csv'},
    {'code': '54', 'name': 'é«˜çŸ¥', 'csv': 'kochi_2020-2025_v3.csv'},
    {'code': '51', 'name': 'å§«è·¯', 'csv': 'himeji_2020-2025_v3.csv'},
]

def run_command(cmd, description):
    """ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ"""
    print(f"\n{'='*80}")
    print(f"{description}")
    print(f"{'='*80}")
    print(f"ã‚³ãƒãƒ³ãƒ‰: {' '.join(cmd)}")
    
    start_time = datetime.now()
    result = subprocess.run(cmd, capture_output=False)
    end_time = datetime.now()
    duration = (end_time - start_time).total_seconds()
    
    if result.returncode == 0:
        print(f"âœ“ æˆåŠŸ ({duration:.1f}ç§’)")
        return True
    else:
        print(f"âœ— å¤±æ•— (çµ‚äº†ã‚³ãƒ¼ãƒ‰: {result.returncode})")
        return False

def main():
    print("="*80)
    print("Phase 4 å®Œå…¨å®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆ")
    print("="*80)
    print(f"é–‹å§‹æ™‚åˆ»: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    
    # Step 1: race_id è¿½åŠ 
    print("\n\nã€Step 1ã€‘race_id ã‚«ãƒ©ãƒ ã®è¿½åŠ ")
    for venue in VENUES:
        csv_file = venue['csv']
        if os.path.exists(csv_file):
            run_command(
                ['python', 'add_race_id_to_csv.py', csv_file],
                f"{venue['name']} ({venue['code']}) - race_idè¿½åŠ "
            )
        else:
            print(f"âš ï¸ ã‚¹ã‚­ãƒƒãƒ—: {csv_file} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
    
    # Step 2: targetå¤‰æ›ï¼ˆèµ°ç ´ã‚¿ã‚¤ãƒ ï¼‰
    print("\n\nã€Step 2ã€‘target ã‚’èµ°ç ´ã‚¿ã‚¤ãƒ ã«å¤‰æ›")
    for venue in VENUES:
        csv_file = venue['csv']
        if os.path.exists(csv_file):
            run_command(
                ['python', 'convert_target_to_time.py', csv_file],
                f"{venue['name']} ({venue['code']}) - targetå¤‰æ›"
            )
        else:
            print(f"âš ï¸ ã‚¹ã‚­ãƒƒãƒ—: {csv_file} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
    
    # Step 3: ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ¢ãƒ‡ãƒ«å­¦ç¿’
    print("\n\nã€Step 3ã€‘ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ¢ãƒ‡ãƒ«å­¦ç¿’")
    for venue in VENUES:
        csv_file_with_race_id = venue['csv'].replace('.csv', '_with_race_id.csv')
        if os.path.exists(csv_file_with_race_id):
            run_command(
                ['python', 'train_ranking_model.py', csv_file_with_race_id],
                f"{venue['name']} ({venue['code']}) - ãƒ©ãƒ³ã‚­ãƒ³ã‚°å­¦ç¿’"
            )
        else:
            print(f"âš ï¸ ã‚¹ã‚­ãƒƒãƒ—: {csv_file_with_race_id} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
    
    # Step 4: å›å¸°ãƒ¢ãƒ‡ãƒ«å­¦ç¿’
    print("\n\nã€Step 4ã€‘å›å¸°ãƒ¢ãƒ‡ãƒ«å­¦ç¿’")
    for venue in VENUES:
        csv_file_time = venue['csv'].replace('.csv', '_time.csv')
        if os.path.exists(csv_file_time):
            run_command(
                ['python', 'train_regression_model.py', csv_file_time],
                f"{venue['name']} ({venue['code']}) - å›å¸°å­¦ç¿’"
            )
        else:
            print(f"âš ï¸ ã‚¹ã‚­ãƒƒãƒ—: {csv_file_time} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
    
    print("\n\n" + "="*80)
    print("Phase 4 å­¦ç¿’å®Œäº†ï¼")
    print("="*80)
    print(f"çµ‚äº†æ™‚åˆ»: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")

if __name__ == "__main__":
    main()
```

---

## ğŸ“Š æœŸå¾…ã•ã‚Œã‚‹æœ€çµ‚æˆæœç‰©

### ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆå„ç«¶é¦¬å ´ Ã— 3ç¨®é¡ = 30ãƒ¢ãƒ‡ãƒ«ï¼‰
```
ooi_2023-2024_v3_model.txt                  # äºŒå€¤åˆ†é¡ï¼ˆPhase 3ã§ä½œæˆæ¸ˆã¿ï¼‰
ooi_2023-2024_v3_ranking_model.txt          # ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆPhase 4ã§ä½œæˆï¼‰
ooi_2023-2024_v3_regression_model.txt       # å›å¸°ï¼ˆPhase 4ã§ä½œæˆï¼‰

funabashi_2020-2025_v3_model.txt
funabashi_2020-2025_v3_ranking_model.txt
funabashi_2020-2025_v3_regression_model.txt

... (ä»–8ç«¶é¦¬å ´ã‚‚åŒæ§˜)
```

### è©•ä¾¡ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆå„ç«¶é¦¬å ´ Ã— 3ç¨®é¡ = 30ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
```
ooi_2023-2024_v3_ranking_score.txt
ooi_2023-2024_v3_regression_score.txt
... (ä»–9ç«¶é¦¬å ´ã‚‚åŒæ§˜)
```

### ã‚¢ãƒ³ã‚µãƒ³ãƒ–ãƒ«äºˆæ¸¬çµæœï¼ˆå„ç«¶é¦¬å ´ = 10ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
```
ensemble_ooi_2026_01.csv
ensemble_funabashi_2026_01.csv
... (ä»–8ç«¶é¦¬å ´ã‚‚åŒæ§˜)
```

---

## âš™ï¸ å®Ÿè¡Œæ‰‹é †ï¼ˆWindowsç’°å¢ƒï¼‰

### æº–å‚™
```bash
cd E:\anonymous-keiba-ai
git pull origin phase4_specialized_models
```

### ã‚µãƒãƒ¼ãƒˆãƒ„ãƒ¼ãƒ«ã®ä½œæˆ
```bash
# Tool 1: race_idè¿½åŠ ãƒ„ãƒ¼ãƒ«
# add_race_id_to_csv.py ã‚’ä½œæˆï¼ˆä¸Šè¨˜ã‚³ãƒ¼ãƒ‰å‚ç…§ï¼‰

# Tool 2: targetå¤‰æ›ãƒ„ãƒ¼ãƒ«
# convert_target_to_time.py ã‚’ä½œæˆï¼ˆä¸Šè¨˜ã‚³ãƒ¼ãƒ‰å‚ç…§ï¼‰

# Tool 3: ä¸€æ‹¬å®Ÿè¡Œãƒ„ãƒ¼ãƒ«
# run_phase4_training.py ã‚’ä½œæˆï¼ˆä¸Šè¨˜ã‚³ãƒ¼ãƒ‰å‚ç…§ï¼‰
```

### å®Ÿè¡Œ
```bash
# æ–¹æ³•1: ä¸€æ‹¬å®Ÿè¡Œï¼ˆæ¨å¥¨ï¼‰
python run_phase4_training.py

# æ–¹æ³•2: æ‰‹å‹•å®Ÿè¡Œ
python add_race_id_to_csv.py ooi_2023-2024_v3.csv
python convert_target_to_time.py ooi_2023-2024_v3.csv
python train_ranking_model.py ooi_2023-2024_v3_with_race_id.csv
python train_regression_model.py ooi_2023-2024_v3_time.csv
# ... ä»–9ç«¶é¦¬å ´ã‚‚åŒæ§˜
```

---

## ğŸ¯ æˆåŠŸã®åŸºæº–

### å¿…é ˆæ¡ä»¶
- âœ… å…¨10ç«¶é¦¬å ´ã§ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ¢ãƒ‡ãƒ«å­¦ç¿’ãŒæˆåŠŸ
- âœ… å…¨10ç«¶é¦¬å ´ã§å›å¸°ãƒ¢ãƒ‡ãƒ«å­¦ç¿’ãŒæˆåŠŸ
- âœ… ã‚¢ãƒ³ã‚µãƒ³ãƒ–ãƒ«äºˆæ¸¬ãŒå®Ÿè¡Œå¯èƒ½
- âœ… æ¨å¥¨åº¦åˆ¥ã®çš„ä¸­ç‡ãŒæ˜ç¢ºåŒ–

### æœŸå¾…ã•ã‚Œã‚‹ç²¾åº¦
- â—æœ¬å‘½ã®çš„ä¸­ç‡: 50-60%ä»¥ä¸Š
- â—‹å¯¾æŠ—ã®çš„ä¸­ç‡: 35-45%ä»¥ä¸Š
- â–²å˜ç©´ã®çš„ä¸­ç‡: 25-35%ä»¥ä¸Š
- å…¨ä½“ã®çš„ä¸­ç‡: Phase 4.5ï¼ˆç´„29%ï¼‰ã‚’ä¸Šå›ã‚‹

---

## ğŸš¨ æ³¨æ„äº‹é …

### ãƒ‡ãƒ¼ã‚¿æº–å‚™æ™‚ã®æ³¨æ„
1. **race_id ã®å½¢å¼**: `YYYYMMDDCCRRR` ï¼ˆå¹´æœˆæ—¥ + ç«¶é¦¬å ´ã‚³ãƒ¼ãƒ‰ + ãƒ¬ãƒ¼ã‚¹ç•ªå·ï¼‰
2. **èµ°ç ´ã‚¿ã‚¤ãƒ ã®å˜ä½**: ç§’å˜ä½ï¼ˆtime / 10.0ï¼‰
3. **æ¬ æå€¤ã®å‡¦ç†**: target ãŒæ¬ æãƒ»ç•°å¸¸å€¤ã®è¡Œã¯å‰Šé™¤

### å­¦ç¿’æ™‚ã®æ³¨æ„
1. **Boruta ã®ä½¿ç”¨**: ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ»å›å¸°ãƒ¢ãƒ‡ãƒ«ã§ã¯ Boruta ã‚’ä½¿ç”¨ã—ãªã„
2. **ç‰¹å¾´é‡ã®çµ±ä¸€**: äºŒå€¤åˆ†é¡ã§é¸å®šã—ãŸç‰¹å¾´é‡ã‚’ä½¿ç”¨
3. **ãƒã‚¤ãƒ‘ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**: Optuna ã«ã‚ˆã‚‹è‡ªå‹•æœ€é©åŒ–ã‚’å®Ÿè¡Œ

### ã‚¢ãƒ³ã‚µãƒ³ãƒ–ãƒ«æ™‚ã®æ³¨æ„
1. **ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã®æ•´åˆæ€§**: 3ã¤ã®ãƒ¢ãƒ‡ãƒ«ãŒåŒã˜ç‰¹å¾´é‡ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã“ã¨
2. **é‡ã¿ã®èª¿æ•´**: åˆæœŸé‡ã¿ï¼ˆäºŒå€¤0.3/ãƒ©ãƒ³ã‚­ãƒ³ã‚°0.5/å›å¸°0.2ï¼‰ã‹ã‚‰é–‹å§‹
3. **é–¾å€¤ã®èª¿æ•´**: äºŒå€¤åˆ†é¡ã®é–¾å€¤ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ0.4ï¼‰ã‚’èª¿æ•´å¯èƒ½

---

## ğŸ“ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆPhase 5ï¼‰

Phase 4 å®Œäº†å¾Œã®å±•æœ›ï¼š

1. **å®Ÿæˆ¦æŠ•å…¥**: å½“æ—¥ãƒ¬ãƒ¼ã‚¹ã§ã®äºˆæ¸¬å®Ÿè¡Œ
2. **å›åç‡åˆ†æ**: æ‰•æˆ»é‡‘ãƒ‡ãƒ¼ã‚¿ã‚’æ´»ç”¨
3. **é‡ã¿ã®æœ€é©åŒ–**: ç«¶é¦¬å ´ã”ã¨ã®æœ€é©é‡ã¿ã‚’æ¢ç´¢
4. **ã‚·ã‚¹ãƒ†ãƒ åŒ–**: Web UI ã®æ§‹ç¯‰
5. **è‡ªå‹•åŒ–**: äºˆæ¸¬ã®è‡ªå‹•å®Ÿè¡Œã‚·ã‚¹ãƒ†ãƒ 

---

**ä½œæˆè€…**: Anonymous Keiba AI Development Team  
**æœ€çµ‚æ›´æ–°**: 2026-02-04  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: å®Ÿè¡Œæº–å‚™å®Œäº†
